# 物流系统完整功能设置文档

## 1. 系统概述

本物流系统实现了一个完整的多承运商、多车辆、多订单的竞价和管理平台，包含订单管理、车辆管理、风控管理、抽佣管理等完整功能模块。

## 2. 核心功能模块

### 2.1 车辆维度的订单竞价系统
#### 2.1.1 车辆订单限制
- 每辆车默认最多同时处理3个订单（可配置）
- 订单状态为 'pending_claim', 'quoted', 'awarded', 'dispatched', 'in_transit' 时计入活跃订单数
- 承运商认领订单时需指定具体车辆

#### 2.1.2 车辆选择机制
- 承运商可查看所有可用车辆
- 系统根据载重、体积、车型等条件过滤可用车辆
- 承运商选择合适车辆进行订单认领

#### 2.1.3 多车竞价一单 vs 一车多单
- **多车竞价一单**：同一承运商的不同车辆可同时竞价同一订单
- **一车多单**：同一车辆可同时处理多个订单（最多3个）
- **优先级机制**：若一车或多车的某订单被客户选择，其余车辆对该订单的报价自动失效

### 2.2 风控管理系统
#### 2.2.1 违规类型定义
- **轻微违规**（客户选择前取消）：车辆禁用30分钟，平台抽成增加2%
- **严重违规**（客户选择后取消）：车辆禁用24小时，平台抽成增加5%
- **其他违规**：延迟配送、货物损坏、服务投诉等

#### 2.2.2 处罚机制
- **0-29分**：正常运营
- **30-49分**：黄色警告，限制功能
- **50-99分**：橙色警告，限制接单
- **≥100分**：红色警告，暂停车辆

#### 2.2.3 申诉机制
- 承运商可对处罚提出申诉
- 管理员审核申诉并做出决定
- 申诉成功可撤销处罚

### 2.3 抽佣管理系统
#### 2.3.1 灵活配置
- 系统级默认抽佣规则
- 车辆级个性化抽佣规则
- 支持固定值、百分比、乘数等多种覆盖类型

#### 2.3.2 违规联动
- 违规行为自动触发抽佣调整
- 违规处罚期间抽佣比例增加
- 处罚期满自动恢复

#### 2.3.3 实时计算
- 订单结算时实时计算最终抽佣比例
- 支持多层级规则叠加
- 自动应用边界限制

## 3. 数据库结构

### 3.1 核心表结构
- **orders**：订单表（增加vehicle_id字段）
- **tenant_vehicles**：车辆表（增加current_active_orders, max_active_orders, penalty_points等字段）
- **violation_records**：违规记录表（增加vehicle_id字段）
- **commission_rules**：抽佣规则表
- **vehicle_commission_overrides**：车辆抽佣覆盖表
- **commission_history**：抽佣历史表

### 3.2 关键字段
- orders.vehicle_id：关联车辆ID
- tenant_vehicles.current_active_orders：当前活跃订单数
- tenant_vehicles.max_active_orders：最大活跃订单数
- tenant_vehicles.penalty_points：处罚积分
- violation_records.vehicle_id：违规关联车辆ID

## 4. API接口体系

### 4.1 承运商端接口
- `GET /api/carrier/vehicles/available` - 获取可用车辆
- `PUT /api/carrier/orders/{order_id}/claim-with-vehicle` - 使用指定车辆认领订单
- `DELETE /api/carrier/orders/{order_id}/release-by-vehicle` - 使用指定车辆释放订单
- `GET /api/carrier/commission/info` - 获取车辆抽佣信息

### 4.2 管理员端接口
- `GET /api/admin/risk-control/violations` - 获取违规记录
- `PUT /api/admin/risk-control/violations/{id}/process` - 处理违规记录
- `POST /api/admin/commission/vehicles/{vehicle_id}/override` - 设置车辆抽佣覆盖
- `GET /api/admin/commission/history` - 获取抽佣历史

## 5. 业务流程

### 5.1 订单竞价流程
1. 客户发布订单（状态：pending_claim）
2. 承运商选择车辆并认领订单
3. 承运商提交报价
4. 客户选择承运商
5. 订单状态更新为awarded

### 5.2 多车竞价处理
1. 同一承运商的多辆车可竞价同一订单
2. 若其中一辆车的报价被客户选择
3. 系统自动取消该承运商其他车辆对该订单的报价
4. 其他车辆可继续处理其他订单

### 5.3 违规处理流程
1. 发生违规行为
2. 创建违规记录
3. 管理员审核处理
4. 执行相应处罚措施
5. 更新车辆状态

### 5.4 抽佣计算流程
1. 订单结算时获取车辆信息
2. 查询基础抽佣规则
3. 检查车辆特定覆盖
4. 检查违规处罚
5. 计算最终抽佣比例
6. 记录抽佣历史

## 6. 配置参数

### 6.1 车辆配置
- 默认最大活跃订单数：3
- 轻微违规处罚时长：30分钟
- 严重违规处罚时长：24小时

### 6.2 违规处罚
- 轻微违规处罚积分：5分
- 严重违规处罚积分：20分
- 处罚积分阈值：100分暂停车辆

### 6.3 抽佣配置
- 默认基础抽成比例：10%
- 轻微违规抽成增加：2%
- 严重违规抽成增加：5%
- 最小抽成比例：0%
- 最大抽成比例：50%

## 7. 管理后台功能

### 7.1 车辆管理
- 查看所有车辆状态
- 调整车辆最大活跃订单数
- 管理车辆处罚状态

### 7.2 违规管理
- 查看违规记录
- 处理违规申诉
- 调整处罚措施

### 7.3 抽佣管理
- 设置系统抽佣规则
- 为车辆设置个性化抽佣
- 查看抽佣历史

### 7.4 实时监控
- 车辆利用率监控
- 违规事件统计
- 抽佣收入分析

## 8. 安全与审计

### 8.1 权限控制
- 管理员权限验证
- 承运商角色验证
- 数据访问权限控制

### 8.2 审计日志
- 所有关键操作记录
- 违规处理日志
- 抽佣调整日志

## 9. 性能优化

### 9.1 缓存策略
- 车辆状态缓存
- 抽佣规则缓存
- 订单状态缓存

### 9.2 索引优化
- 车辆ID索引
- 订单状态索引
- 时间范围索引

## 10. 部署与运维

### 10.1 部署步骤
1. 数据库结构更新
2. API服务部署
3. 前端界面更新
4. 配置参数设置

### 10.2 运维监控
- 系统性能监控
- 业务指标监控
- 异常告警机制

## 11. 后续优化方向

### 11.1 智能调度
- 基于地理位置的车辆推荐
- 智能路径规划
- 动态定价策略

### 11.2 信用体系
- 车辆信用评级
- 差异化服务策略
- 激励机制

此系统实现了完整的车辆维度订单管理、风控管理和抽佣管理功能，为物流平台提供了全面的运营支撑。