# 承运商多订单管理功能增强方案

## 背景
当前系统支持多承运商对单一订单的竞价，但缺乏对单个承运商同时处理多个订单的管理功能。本方案旨在增强系统，允许承运商同时参与多个订单的竞价，并提供订单管理功能。

## 增强功能

### 1. 承运商最大活跃订单数限制
- 为每个承运商设置最大活跃订单数（默认3个）
- 在认领订单时检查当前活跃订单数
- 防止承运商超负荷接单

### 2. 承运商活跃订单查询
- 查询承运商当前所有活跃订单
- 显示订单状态、报价情况、竞争情况
- 提供承运商容量信息

### 3. 订单释放功能
- 允许承运商主动释放订单
- 根据订单认领情况智能处理（是否重置为可认领状态）

## API 接口更新

### 增强版认领订单接口
```
PUT /api/carrier/orders/{order_id}/claim
```
- 检查承运商当前活跃订单数
- 防止重复认领
- 返回当前活跃订单统计

### 承运商活跃订单查询接口
```
GET /api/carrier/orders/active
```
- 返回承运商当前所有活跃订单
- 包含订单状态、报价、竞争情况
- 提供汇总信息

### 承运商释放订单接口
```
DELETE /api/carrier/orders/{order_id}/release
```
- 允许承运商主动释放订单
- 智能处理订单状态（重置或仅移除当前承运商）

## 数据库扩展

### 承运商配置表扩展
在 `tenants` 表中增加字段：
- `max_active_orders` - 最大活跃订单数
- `current_active_orders` - 当前活跃订单数（可选，通过查询计算）

## 实现逻辑

### 1. 认领订单逻辑
```
1. 验证订单状态为 'pending_claim'
2. 检查承运商当前活跃订单数是否超过限制
3. 检查是否已认领此订单
4. 更新订单的 carrier_id，保持状态为 'pending_claim'
5. 返回更新后的活跃订单统计
```

### 2. 订单状态管理
- `pending_claim`: 订单可被认领
- `quoted`: 承运商已报价
- `awarded`: 客户已选择
- `dispatched/in_transit`: 承运商正在配送
- 承运商可同时处理以上状态的多个订单

### 3. 资源管理
- 承运商可同时认领多个订单
- 承运商可随时释放未被客户选择的订单
- 系统限制承运商最大活跃订单数

## 业务价值

1. **提升承运商效率**: 允许承运商同时管理多个订单
2. **优化资源配置**: 防止承运商超负荷运营
3. **增强灵活性**: 承运商可根据实际情况调整订单组合
4. **改善用户体验**: 更快的订单响应和处理

## 部署建议

1. 更新API处理器
2. 更新前端界面（小程序和管理后台）
3. 添加配置管理功能
4. 进行充分测试