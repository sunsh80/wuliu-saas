openapi: 3.0.3
info:
  title: å¤šç§Ÿæˆ·ç‰©æµå¹³å° API
  version: 1.0.2-safe
    æŠ€æœ¯æ ˆ:Node.js + Express + SQLite + OpenAPI Backend
    è®¤è¯æœºåˆ¶:express-session(åŸºäº Cookie çš„ä¼šè¯ï¼‰
    å®‰å…¨æ¨¡å‹ï¼šé€šè¿‡ TenantSessionAuth å®‰å…¨å¤„ç†å™¨æ ¡éªŒ req.session.userId
    å¤šç§Ÿæˆ·æ”¯æŒ:tenants è¡¨å­˜å‚¨ç§Ÿæˆ·,users è¡¨å­˜å‚¨ç§Ÿæˆ·å‘˜å·¥ & å°ç¨‹åºé¡¾å®¢
  description: |
    æ”¯æŒå®¢æˆ·ï¼ˆä¸‹å•æ–¹ï¼‰ä¸æ‰¿è¿æ–¹ï¼ˆæ¥å•æ–¹ï¼‰åŒè§’è‰²çš„ç‰©æµè®¢å•ç³»ç»Ÿã€‚
    - `/api/admin/...`ï¼šå¹³å°ç®¡ç†å‘˜
    - `/api/customer/...`ï¼šå®¢æˆ·ç§Ÿæˆ·
    - `/api/carrier/...`ï¼šæ‰¿è¿æ–¹ç§Ÿæˆ·
    - `/api/public/...`ï¼šå…¬å…±æ¥å£
    ğŸ”¹ æœ¬æ¬¡å¢å®¹(v1.0.2-safe):
    - ä¿ç•™æ‰€æœ‰ v1.0.1 å­—æ®µã€è·¯ç”±ã€çŠ¶æ€ä¸å˜
    - æ–°å¢æ‰¿è¿æ–¹èƒ½åŠ›ç”»åƒï¼ˆå¯é€‰ï¼‰
    - ç§Ÿæˆ·æœ¬èº«å¯ä»¥åœ¨ä¸€å®šæ¡ä»¶ä¸‹è½¬å˜ä¸ºæ‰¿è¿æ–¹ï¼Œå®¢æˆ·ï¼Œä»“åº“å®ä½“
    - æ–°å¢ä½“ç§¯ã€æ—¶æ•ˆç­‰å¯é€‰å­—æ®µ
    - æ–°å¢åŒ¹é…ç›¸å…³æ¥å£ï¼ˆä¸æ”¹åŠ¨åŸæœ‰ claim/award æµç¨‹ï¼‰
servers:
  - url: http://localhost:3000
    description: å¼€å‘ç¯å¢ƒ
tags:
  - name: setup
    description: å¹³å°åˆå§‹åŒ–ï¼ˆé¦–æ¬¡å®‰è£…ï¼‰
  - name: admin-auth
    description: å¹³å°ç®¡ç†å‘˜ - è®¤è¯ä¸ä¼šè¯
  - name: admin-user
    description: å¹³å°ç®¡ç†å‘˜ - ç”¨æˆ·ç®¡ç†
  - name: admin-tenant
    description: å¹³å°ç®¡ç†å‘˜ - ç§Ÿæˆ·ç®¡ç†
  - name: admin-order
    description: å¹³å°ç®¡ç†å‘˜ - è®¢å•ç®¡ç†
  - name: customer-order
    description: å®¢æˆ·ç§Ÿæˆ· - åˆ›å»ºä¸æŸ¥çœ‹è‡ªå·±çš„è®¢å•
  - name: carrier-order
    description: æ‰¿è¿æ–¹ç§Ÿæˆ· - è®¤é¢†ã€æ‰§è¡Œè®¢å•
  - name: public
    description: å…¬å…±æ¥å£ï¼ˆå°ç¨‹åºä½¿ç”¨ï¼Œæœªæ¥åºŸå¼ƒï¼‰
  - name: auth
    description: ç§Ÿæˆ·è®¤è¯ä¸ä¼šè¯
  - name: matching
    description: æ™ºèƒ½åŒ¹é…ï¼ˆæ–°å¢ï¼Œå¯é€‰ä½¿ç”¨ï¼‰
components:
  securitySchemes:
    AdminSessionAuth:
      type: apiKey
      in: cookie
      name: connect.sid
      description: å¹³å°ç®¡ç†å‘˜ç™»å½•åè‡ªåŠ¨æºå¸¦ï¼ˆç”± Express Session ç®¡ç†ï¼‰
    TenantSessionAuth:
      type: apiKey
      in: cookie
      name: connect.sid
      description: ç§Ÿæˆ·ç™»å½•åè‡ªåŠ¨æºå¸¦ï¼ˆç”± Express Session ç®¡ç†ï¼‰
  schemas:
    # --- ç§Ÿæˆ·ç›¸å…³ ---
    TenantApplication:
      type: object
      required:
        - name
        - contact_person
        - contact_phone
        - email
        - password
        - roles
      properties:
        name:
          type: string
          example: "ABC ç‰©æµå…¬å¸"
        contact_person:
          type: string
          example: "å¼ ä¸‰"
        contact_phone:
          type: string
          pattern: '^1[3-9]\d{9}$'
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6
        roles:
          type: array
          items:
            type: string
            enum: [customer, carrier]
          minItems: 1
          example: ["customer", "carrier"]
        # === æ–°å¢ï¼šå¯é€‰èƒ½åŠ›å­—æ®µï¼ˆä¸å½±å“æ—§é€»è¾‘ï¼‰===
        address:
          type: string
          example: "ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºXXè·¯XXå·"
        service_radius_km:
          type: integer
          minimum: 1
          example: 200
        capacity_kg:
          type: number
          minimum: 0.1
          example: 5000
        capacity_m3:
          type: number
          minimum: 0.1
          example: 30
        base_price_per_km:
          type: number
          minimum: 0.01
          example: 2.5
    TenantProfile:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        contact_person:
          type: string
        roles:
          type: array
          items:
            type: string
            enum: [customer, carrier]
        # === æ–°å¢ï¼šå¯é€‰èƒ½åŠ›å­—æ®µ ===
        address:
          type: string
        service_radius_km:
          type: integer
        capacity_kg:
          type: number
        capacity_m3:
          type: number
        base_price_per_km:
          type: number
        avg_rating:
          type: number
          minimum: 0
          maximum: 5
    # --- æŠ¥ä»·æ¨¡å‹ ---
    QuoteRequest:
      type: object
      required:
        - price
      properties:
        price:
          type: number
          minimum: 0.01
          example: 150.0
        estimated_hours:
          type: integer
          minimum: 1
          example: 24
        # === æ–°å¢ï¼šæ›´ç²¾ç¡®çš„åˆ°è¾¾æ—¶é—´ï¼ˆå¯é€‰ï¼‰===
        estimated_arrival:
          type: string
          format: date-time
          example: "2026-01-14T18:00:00Z"
        note:
          type: string
          example: "è‡ªæœ‰è½¦è¾†ï¼Œ24å°æ—¶å†…è£…è½¦"
    QuoteItem:
      type: object
      properties:
        id:
          type: string
        order_id:
          type: string
        carrier_tenant_id:
          type: string
        carrier_tenant_name:
          type: string
        price:
          type: number
        estimated_hours:
          type: integer
        # === æ–°å¢ ===
        estimated_arrival:
          type: string
          format: date-time
        avg_rating:
          type: number
        match_score:
          type: number
        note:
          type: string
        created_at:
          type: string
          format: date-time
    # --- è®¢å•ç›¸å…³ ---
    CreateOrderRequest:
      type: object
      required:
        - pickup_address
        - delivery_address
        - weight_kg
      properties:
        pickup_address:
          type: string
          example: "åŒ—äº¬å¸‚æœé˜³åŒºXXå¤§å¦"
        delivery_address:
          type: string
          example: "ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºYYå›­åŒº"
        weight_kg:
          type: number
          format: float
          minimum: 0.1
          example: 25.5
        # === æ–°å¢å¯é€‰å­—æ®µ ===
        volume_m3:
          type: number
          minimum: 0.01
          example: 1.2
        required_delivery_time:
          type: string
          format: date-time
          example: "2026-01-15T12:00:00Z"
        quote_deadline:
          type: string
          format: date-time
          example: "2026-01-14T10:00:00Z"
        # åŸæœ‰å­—æ®µ
        customer_name:
          type: string
          example: "æå››"
        customer_phone:
          type: string
          pattern: '^1[3-9]\d{9}$'
          example: "13800138000"
        description:
          type: string
          example: "æ˜“ç¢å“ï¼Œè¯·è½»æ‹¿è½»æ”¾"

    OrderItem:
      type: object
      properties:
        id:
          type: string
          example: "order_123e4567-e89b-12d3-a456-426614174000"
        customer_tenant_id:
          type: string
        customer_tenant_name:
          type: string
        carrier_tenant_id:
          type: string
          nullable: true
        carrier_tenant_name:
          type: string
          nullable: true
        pickup_address:
          type: string
        delivery_address:
          type: string
        weight_kg:
          type: number
        # === æ–°å¢å¯é€‰å­—æ®µ ===
        volume_m3:
          type: number
        required_delivery_time:
          type: string
          format: date-time
        quote_deadline:
          type: string
          format: date-time
        status:
          type: string # âš ï¸ ä¸¥æ ¼ä¿ç•™åŸçŠ¶æ€æšä¸¾ï¼
          enum: [created, claimed, awarded, dispatched, in_transit, delivered, cancelled]
        created_at:
          type: string
          format: date-time
        quotes:
          type: array
          items:
            $ref: '#/components/schemas/QuoteItem'
          nullable: true
    OrderListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: "TENANT_ROLE_NOT_ENABLED"
        message:
          type: string
          example: "å½“å‰ç§Ÿæˆ·æœªå¯ç”¨å®¢æˆ·è§’è‰²"

    # --- ç§Ÿæˆ·ç®¡ç†ç›¸å…³è¡¥å……æ¨¡å‹ ---
    TenantListItem:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        contact_person:
          type: string
        contact_phone:
          type: string
        email:
          type: string
        status:
          type: string
          enum: [pending, approved, rejected, active, inactive]
        created_at:
          type: string
          format: date-time
        address:
          type: string
        service_radius_km:
          type: integer
        capacity_kg:
          type: number
        capacity_m3:
          type: number
        base_price_per_km:
          type: number
        avg_rating:
          type: number
          minimum: 0
          maximum: 5

    TenantDetail:
      allOf:
        - $ref: '#/components/schemas/TenantListItem'
        - type: object
          properties:
            updated_at:
              type: string
              format: date-time
            vehicles:
              type: array
              items:
                $ref: '#/components/schemas/VehicleInfo'
            financial_info:
              $ref: '#/components/schemas/TenantFinancialInfo'
            contact_info:
              $ref: '#/components/schemas/TenantContactInfo'

    VehicleInfo:
      type: object
      properties:
        id:
          type: integer
        plate_number:
          type: string
        type:
          type: string
        length:
          type: number
        width:
          type: number
        height:
          type: number
        max_weight:
          type: number
        volume:
          type: number
        status:
          type: string
        driver_name:
          type: string
        driver_phone:
          type: string
        image_url:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TenantFinancialInfo:
      type: object
      properties:
        bank_account_number:
          type: string
        bank_name:
          type: string
        tax_id:
          type: string
        settlement_cycle:
          type: string
        credit_limit:
          type: number
        outstanding_balance:
          type: number
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TenantContactInfo:
      type: object
      properties:
        finance_contact_name:
          type: string
        finance_contact_phone:
          type: string
        finance_contact_email:
          type: string
        support_contact_name:
          type: string
        support_contact_phone:
          type: string
        support_contact_email:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PaginationInfo:
      type: object
      properties:
        current_page:
          type: integer
        total_pages:
          type: integer
        total_items:
          type: integer
        per_page:
          type: integer

  responses:
    UnauthorizedError:
      description: æœªè®¤è¯
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ForbiddenError:
      description: æƒé™ä¸è¶³ï¼ˆå¦‚è§’è‰²ä¸åŒ¹é…ï¼‰
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFoundError:
      description: èµ„æºä¸å­˜åœ¨
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalServerError:
      description: å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

paths:
  /api/admin/tenants:
    get:
      tags:
        - admin-tenant
      operationId: listAllTenants
      summary: è·å–æ‰€æœ‰ç§Ÿæˆ·ï¼ˆåˆ†é¡µã€å¯ç­›é€‰ï¼‰
      description: è·å–å¹³å°æ‰€æœ‰ç§Ÿæˆ·çš„åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µã€çŠ¶æ€ç­›é€‰å’Œå…³é”®è¯æœç´¢ã€‚
      security:
        - AdminSessionAuth: []
      parameters:
        - name: page
          in: query
          description: é¡µç 
          required: false
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: æ¯é¡µæ•°é‡
          required: false
          schema:
            type: integer
            default: 10
        - name: status
          in: query
          description: ç­›é€‰ç§Ÿæˆ·çŠ¶æ€
          required: false
          schema:
            type: string
            enum: [pending, approved, rejected, active, inactive]
        - name: search
          in: query
          description: æœç´¢ç§Ÿæˆ·åç§°æˆ–è”ç³»äºº
          required: false
          schema:
            type: string
      responses:
        '200':
          description: ç§Ÿæˆ·åˆ—è¡¨
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      tenants:
                        type: array
                        items:
                          $ref: '#/components/schemas/TenantListItem'
                      pagination:
                        $ref: '#/components/schemas/PaginationInfo'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/admin/tenants/{id}:
    get:
      tags:
        - admin-tenant
      operationId: getTenantById
      summary: è·å–å•ä¸ªç§Ÿæˆ·è¯¦æƒ…
      description: è·å–æŒ‡å®šIDç§Ÿæˆ·çš„å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŸºæœ¬ä¿¡æ¯ã€è½¦è¾†ã€è´¢åŠ¡å’Œå®¢æœä¿¡æ¯ã€‚
      security:
        - AdminSessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: ç§Ÿæˆ·è¯¦æƒ…
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/TenantDetail'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/customer/orders/{orderId}/quotes:
    get:
      tags:
        - customer-order
      summary: è·å–è®¢å•çš„æŠ¥ä»·åˆ—è¡¨
      operationId: getOrderQuotes
      security:
        - TenantSessionAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: è®¢å•æŠ¥ä»·åˆ—è¡¨
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      order_id:
                        type: string
                      quotes:
                        type: array
                        items:
                          type: object
                          properties:
                            carrier:
                              type: object
                              properties:
                                id:
                                  type: integer
                                name:
                                  type: string
                                tenant_name:
                                  type: string
                            price:
                              type: number
                            delivery_time:
                              type: string
                            remarks:
                              type: string
                            status:
                              type: string
                            created_at:
                              type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /api/carrier/orders/{order_id}/start-delivery:
    put:
      tags:
        - carrier-order
      summary: æ‰¿è¿å•†å¼€å§‹é…é€è®¢å•
      operationId: startDelivery
      security:
        - TenantSessionAuth: []
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: å¼€å§‹é…é€æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      order_id:
                        type: string
                      status:
                        type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '400':
          $ref: '#/components/responses/ForbiddenError'

  /api/admin/tenants/{id}/financial:
  /api/admin/tenants/{id}/contact:
  /api/admin/tenants/{id}/vehicles:
  /api/health:
  /api/customer/order/bind:
  /api/customer/orders:
  /api/customer/orders/{orderId}:
  /api/setup/status:
  /api/setup/admin:
  /api/admin/login:
  /api/admin/logout:
  /api/admin/profile:
  /api/admin/users:
  /api/admin/tenants/pending:
  /api/admin/tenants/{id}/approve:
  /api/admin/tenants/{id}/reject:
  /api/admin/orders:
  /api/admin/orders/{id}/status:
  /api/public/orders/{id}:
  /api/public/orders:
  /api/carrier/orders:
  /api/carrier/orders/{order_id}/claim:
  /api/carrier/orders/{order_id}/complete:
  /api/carrier/orders/{orderId}/quote:
  /api/customer/orders/{order_id}/award:
  /api/tenant-web/register:
  /api/tenant-web/login:
  /api/tenant-web/profile:
  /api/tenant-web/profile/roles:
  /api/pc-tenant/apply:
  /api/tenant-web/orders/pending:
  /api/tenant-web/orders/{orderId}/claim:
  /api/tenant-web/orders/{orderId}/complete:
  /api/tenant-web/logout:
  /api/matching/search-carriers:
  /api/matching/get-quote-suggestions: