<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>站点维护 - 承运商系统</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #f97316; /* 橙色主色调 */
            --primary-dark: #ea580c; /* 深橙色 */
            --primary-light: #fb923c; /* 浅橙色 */
            --sidebar-bg: #1e293b; /* 深蓝灰色侧边栏 */
            --sidebar-item-hover: #334155; /* 侧边栏项目悬停色 */
            --topbar-bg: #ffffff; /* 顶部栏白色 */
            --topbar-text: #1e293b; /* 顶部栏文字深色 */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            color: #334155;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .main-content {
            padding: 80px 24px 24px 270px; /* 为顶部栏和侧边栏留出空间 */
            min-height: calc(100vh - 104px);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 4px 2px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }

        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .location-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .location-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .location-type {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .location-details {
            margin-bottom: 16px;
        }

        .detail-item {
            display: flex;
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: 600;
            color: #64748b;
            min-width: 80px;
        }

        .detail-value {
            flex: 1;
            color: #334155;
        }

        .location-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .map-container {
            height: 400px;
            background-color: #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .map-placeholder {
            text-align: center;
            color: #64748b;
        }

        .map-placeholder i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #94a3b8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close {
            color: #94a3b8;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover,
        .close:focus {
            color: #334155;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <aside class="sidebar">
        <div class="logo">
            <i class="fas fa-truck-moving"></i>
            <span>承运商系统</span>
        </div>
        <ul>
            <li><a href="/carrier/index.html"><i class="fas fa-home"></i> <span>首页</span></a></li>
            <li><a href="/carrier/orders.html"><i class="fas fa-tasks"></i> <span>订单管理</span></a></li>
            <li><a href="/carrier/quotes.html"><i class="fas fa-tags"></i> <span>报价管理</span></a></li>
            <li><a href="/carrier/locations.html" class="active"><i class="fas fa-map-marker-alt"></i> <span>站点维护</span></a></li>
            <li><a href="/carrier/messages.html"><i class="fas fa-envelope"></i> <span>消息</span></a></li>
            <li><a href="/carrier/finance.html"><i class="fas fa-wallet"></i> <span>财务</span></a></li>
            <li><a href="/carrier/profile.html"><i class="fas fa-user"></i> <span>个人资料</span></a></li>
        </ul>
    </aside>

    <!-- 顶部栏 -->
    <header class="topbar">
        <div class="user-info">
            <span id="userName">承运商用户</span>
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> 退出登录</a>
        </div>
    </header>

    <!-- 主内容区域 -->
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">站点维护</h1>
            <div>
                <button class="btn btn-primary" onclick="openAddLocationModal()">
                    <i class="fas fa-plus"></i> 添加站点
                </button>
                <button class="btn btn-warning" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>

        <!-- 搜索框 -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索站点名称、地址或联系人...">
            <button class="btn btn-primary" onclick="searchLocations()">
                <i class="fas fa-search"></i> 搜索
            </button>
            <button class="btn btn-warning" onclick="clearSearch()">
                <i class="fas fa-times"></i> 清空
            </button>
        </div>

        <!-- 地图容器 -->
        <div class="map-container">
            <div class="map-placeholder">
                <i class="fas fa-map-marked-alt"></i>
                <h3>第三方地图集成</h3>
                <p>用于显示所有站点位置及路线规划</p>
            </div>
        </div>

        <!-- 站点列表 -->
        <div class="location-grid" id="locationsContainer">
            <!-- 站点卡片将通过JS动态填充 -->
        </div>
    </div>

    <!-- 添加/编辑站点模态框 -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">添加站点</h2>
                <span class="close" onclick="closeLocationModal()">&times;</span>
            </div>
            <form id="locationForm">
                <input type="hidden" id="locationId">
                <div class="form-group">
                    <label for="locationName">站点名称 *</label>
                    <input type="text" id="locationName" required placeholder="请输入站点名称">
                </div>
                <div class="form-group">
                    <label for="locationType">站点类型 *</label>
                    <select id="locationType" required>
                        <option value="">请选择站点类型</option>
                        <option value="depot">仓库/分拣中心</option>
                        <option value="transit_point">中转站</option>
                        <option value="delivery_point">配送点</option>
                        <option value="collection_point">揽收点</option>
                        <option value="service_station">服务中心</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="locationAddress">详细地址 *</label>
                    <input type="text" id="locationAddress" required placeholder="请输入详细地址">
                </div>
                <div class="form-group">
                    <label for="locationContact">联系人</label>
                    <input type="text" id="locationContact" placeholder="请输入联系人姓名">
                </div>
                <div class="form-group">
                    <label for="locationPhone">联系电话</label>
                    <input type="text" id="locationPhone" placeholder="请输入联系电话">
                </div>
                <div class="form-group">
                    <label for="locationCapacity">承载能力 (吨)</label>
                    <input type="number" id="locationCapacity" placeholder="请输入承载能力" min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label for="locationDescription">描述</label>
                    <textarea id="locationDescription" rows="3" placeholder="请输入站点描述"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">保存站点</button>
                    <button type="button" class="btn" onclick="closeLocationModal()" style="background-color: #94a3b8; color: white;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script>
        let locations = [];
        let editingLocationId = null;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadLocations();
        });

        // 检查登录状态
        function checkLoginStatus() {
            const token = localStorage.getItem('carrierToken');
            if (!token) {
                window.location.href = '/carrier-login.html';
            }

            // 获取用户信息
            try {
                const carrierInfo = JSON.parse(localStorage.getItem('carrierInfo'));
                if (carrierInfo) {
                    document.getElementById('userName').textContent = carrierInfo.name || carrierInfo.username || '承运商用户';
                }
            } catch (e) {
                console.error('获取用户信息失败:', e);
            }
        }

        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('carrierToken');
                localStorage.removeItem('carrierInfo');
                window.location.href = '/carrier-login.html';
            }
        });

        // 加载站点数据
        async function loadLocations() {
            try {
                const token = localStorage.getItem('carrierToken');
                const response = await fetch('/api/tenant-web/locations', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    locations = data.data.locations || [];
                    displayLocations(locations);
                } else {
                    console.error('获取站点数据失败:', response.status);
                    // 使用模拟数据
                    locations = [
                        {
                            id: 1,
                            name: '总部仓储中心',
                            type: 'depot',
                            address: '北京市朝阳区物流大道1号',
                            contact_person: '张经理',
                            contact_phone: '13800138001',
                            capacity: 500,
                            description: '主要仓储和分拣中心',
                            created_at: '2026-01-15 09:00:00',
                            updated_at: '2026-01-15 09:00:00'
                        },
                        {
                            id: 2,
                            name: '东城配送站',
                            type: 'delivery_point',
                            address: '北京市东城区配送路10号',
                            contact_person: '李主管',
                            contact_phone: '13800138002',
                            capacity: 50,
                            description: '负责东城区最后一公里配送',
                            created_at: '2026-01-20 10:30:00',
                            updated_at: '2026-01-20 10:30:00'
                        },
                        {
                            id: 3,
                            name: '西郊中转站',
                            type: 'transit_point',
                            address: '北京市丰台区中转街5号',
                            contact_person: '王站长',
                            contact_phone: '13800138003',
                            capacity: 200,
                            description: '进出京货物中转站',
                            created_at: '2026-01-25 14:15:00',
                            updated_at: '2026-01-25 14:15:00'
                        }
                    ];
                    displayLocations(locations);
                }
            } catch (error) {
                console.error('加载站点数据时出错:', error);
                // 使用模拟数据
                locations = [
                    {
                        id: 1,
                        name: '总部仓储中心',
                        type: 'depot',
                        address: '北京市朝阳区物流大道1号',
                        contact_person: '张经理',
                        contact_phone: '13800138001',
                        capacity: 500,
                        description: '主要仓储和分拣中心',
                        created_at: '2026-01-15 09:00:00',
                        updated_at: '2026-01-15 09:00:00'
                    },
                    {
                        id: 2,
                        name: '东城配送站',
                        type: 'delivery_point',
                        address: '北京市东城区配送路10号',
                        contact_person: '李主管',
                        contact_phone: '13800138002',
                        capacity: 50,
                        description: '负责东城区最后一公里配送',
                        created_at: '2026-01-20 10:30:00',
                        updated_at: '2026-01-20 10:30:00'
                    },
                    {
                        id: 3,
                        name: '西郊中转站',
                        type: 'transit_point',
                        address: '北京市丰台区中转街5号',
                        contact_person: '王站长',
                        contact_phone: '13800138003',
                        capacity: 200,
                        description: '进出京货物中转站',
                        created_at: '2026-01-25 14:15:00',
                        updated_at: '2026-01-25 14:15:00'
                    }
                ];
                displayLocations(locations);
            }
        }

        // 显示站点
        function displayLocations(locationsToShow) {
            const container = document.getElementById('locationsContainer');
            container.innerHTML = '';

            if (locationsToShow.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;"><i class="fas fa-map-marker-alt" style="font-size: 3rem; margin-bottom: 16px;"></i><h3>暂无站点数据</h3><p>点击"添加站点"按钮创建第一个站点</p></div>';
                return;
            }

            locationsToShow.forEach(location => {
                const card = document.createElement('div');
                card.className = 'location-card';
                
                // 获取站点类型文本
                const typeText = getLocationTypeText(location.type);
                
                card.innerHTML = `
                    <div class="location-header">
                        <h3 class="location-name">${location.name}</h3>
                        <span class="location-type">${typeText}</span>
                    </div>
                    <div class="location-details">
                        <div class="detail-item">
                            <span class="detail-label">地址:</span>
                            <span class="detail-value">${location.address}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">联系人:</span>
                            <span class="detail-value">${location.contact_person || '未设置'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">电话:</span>
                            <span class="detail-value">${location.contact_phone || '未设置'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">承载能力:</span>
                            <span class="detail-value">${location.capacity ? location.capacity + ' 吨' : '未设置'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">描述:</span>
                            <span class="detail-value">${location.description || '无描述'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">创建时间:</span>
                            <span class="detail-value">${new Date(location.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="location-actions">
                        <button class="btn btn-primary" onclick="openEditLocationModal(${location.id})">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-danger" onclick="deleteLocation(${location.id})">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // 获取站点类型文本
        function getLocationTypeText(type) {
            const typeMap = {
                'depot': '仓库/分拣中心',
                'transit_point': '中转站',
                'delivery_point': '配送点',
                'collection_point': '揽收点',
                'service_station': '服务中心'
            };
            return typeMap[type] || type;
        }

        // 打开添加站点模态框
        function openAddLocationModal() {
            document.getElementById('modalTitle').textContent = '添加站点';
            document.getElementById('locationForm').reset();
            document.getElementById('locationId').value = '';
            editingLocationId = null;
            document.getElementById('locationModal').style.display = 'block';
        }

        // 打开编辑站点模态框
        function openEditLocationModal(locationId) {
            const location = locations.find(loc => loc.id == locationId);
            if (!location) return;

            document.getElementById('modalTitle').textContent = '编辑站点';
            document.getElementById('locationId').value = location.id;
            document.getElementById('locationName').value = location.name;
            document.getElementById('locationType').value = location.type;
            document.getElementById('locationAddress').value = location.address;
            document.getElementById('locationContact').value = location.contact_person || '';
            document.getElementById('locationPhone').value = location.contact_phone || '';
            document.getElementById('locationCapacity').value = location.capacity || '';
            document.getElementById('locationDescription').value = location.description || '';

            editingLocationId = locationId;
            document.getElementById('locationModal').style.display = 'block';
        }

        // 关闭模态框
        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
        }

        // 保存站点
        async function saveLocation(event) {
            event.preventDefault();

            const id = document.getElementById('locationId').value;
            const name = document.getElementById('locationName').value.trim();
            const type = document.getElementById('locationType').value;
            const address = document.getElementById('locationAddress').value.trim();
            const contactPerson = document.getElementById('locationContact').value.trim();
            const contactPhone = document.getElementById('locationPhone').value.trim();
            const capacity = document.getElementById('locationCapacity').value;
            const description = document.getElementById('locationDescription').value.trim();

            if (!name || !type || !address) {
                alert('请填写必填字段：站点名称、类型和地址');
                return;
            }

            try {
                const token = localStorage.getItem('carrierToken');
                const locationData = {
                    name,
                    type,
                    address,
                    contact_person: contactPerson || null,
                    contact_phone: contactPhone || null,
                    capacity: capacity ? parseFloat(capacity) : null,
                    description: description || null
                };

                let response;
                if (id) {
                    // 编辑现有站点
                    response = await fetch(`/api/tenant-web/locations/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(locationData)
                    });
                } else {
                    // 添加新站点
                    response = await fetch('/api/tenant-web/locations', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(locationData)
                    });
                }

                if (response.ok) {
                    alert(id ? '站点更新成功！' : '站点添加成功！');
                    closeLocationModal();
                    loadLocations(); // 重新加载数据
                } else {
                    const errorData = await response.json();
                    alert(`操作失败: ${errorData.message || errorData.error}`);
                }
            } catch (error) {
                console.error('保存站点时出错:', error);
                alert('保存站点时出错');
            }
        }

        // 删除站点
        async function deleteLocation(locationId) {
            if (!confirm('确定要删除这个站点吗？此操作不可撤销。')) return;

            try {
                const token = localStorage.getItem('carrierToken');
                const response = await fetch(`/api/tenant-web/locations/${locationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('站点删除成功！');
                    loadLocations(); // 重新加载数据
                } else {
                    const errorData = await response.json();
                    alert(`删除失败: ${errorData.message || errorData.error}`);
                }
            } catch (error) {
                console.error('删除站点时出错:', error);
                alert('删除站点时出错');
            }
        }

        // 搜索站点
        function searchLocations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!searchTerm) {
                displayLocations(locations);
                return;
            }

            const filteredLocations = locations.filter(location => 
                location.name.toLowerCase().includes(searchTerm) ||
                location.address.toLowerCase().includes(searchTerm) ||
                (location.contact_person && location.contact_person.toLowerCase().includes(searchTerm)) ||
                (location.contact_phone && location.contact_phone.includes(searchTerm))
            );

            displayLocations(filteredLocations);
        }

        // 清空搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            displayLocations(locations);
        }

        // 表单提交事件
        document.getElementById('locationForm').addEventListener('submit', saveLocation);

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('locationModal');
            if (event.target === modal) {
                closeLocationModal();
            }
        }
    </script>
</body>
</html>