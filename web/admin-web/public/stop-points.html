<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœé ç‚¹ç®¡ç† - ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main-content {
      padding: 24px;
      margin-top: 60px;
      margin-left: 250px;
      margin-right: 20px;
      width: calc(100% - 270px);
      min-height: calc(100vh - 80px);
    }

    /* é¡¶éƒ¨æ  */
    .topbar {
      position: fixed;
      top: 0;
      right: 0;
      left: 250px;
      height: 60px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 30px;
      z-index: 999;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info span {
      color: #666;
    }

    .user-info a {
      color: #ff4d4f;
      text-decoration: none;
      cursor: pointer;
    }

    .user-info a:hover {
      text-decoration: underline;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
    .stat-card .num { font-size: 28px; font-weight: bold; }
    .stat-card.pending .num { color: #faad14; }
    .stat-card.approved .num { color: #52c41a; }
    .stat-card.rejected .num { color: #ff4d4f; }
    .stat-card.total .num { color: #1890ff; }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.07);
      padding: 24px;
      margin-bottom: 24px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .card-title { font-size: 18px; font-weight: bold; color: #333; }

    .filter-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-row input, .filter-row select {
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      font-size: 14px;
    }
    .filter-row input { min-width: 200px; }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    .btn-primary { background: #1890ff; color: white; }
    .btn-primary:hover { background: #40a9ff; transform: translateY(-1px); }
    .btn-success { background: #52c41a; color: white; }
    .btn-success:hover { background: #73d13d; }
    .btn-danger { background: #ff4d4f; color: white; }
    .btn-danger:hover { background: #ff7875; }
    .btn-warning { background: #faad14; color: white; }
    .btn-warning:hover { background: #ffc53d; }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-secondary:hover { background: #d9d9d9; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    .btn-group { display: flex; gap: 8px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
    th { background: #fafafa; font-weight: 600; color: #333; font-size: 14px; }
    tr:hover { background: #f5f5f5; }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-active { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
    .status-inactive { background: #fff1f0; color: #ff4d4f; border: 1px solid #ffa39e; }
    .status-pending { background: #fffbe6; color: #faad14; border: 1px solid #ffe58f; }
    .status-approved { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
    .status-rejected { background: #fff1f0; color: #ff4d4f; border: 1px solid #ffa39e; }

    .type-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      background: #f0f0f0;
      color: #666;
    }

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .pagination-info { color: #666; font-size: 14px; }
    .pagination-btns { display: flex; gap: 8px; }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal.show { display: flex; justify-content: center; align-items: center; }
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 { font-size: 18px; color: #333; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .modal-close:hover { color: #333; }
    .modal-body { padding: 20px; }
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-item { margin-bottom: 16px; }
    .form-item label { display: block; margin-bottom: 6px; font-weight: 500; color: #333; }
    .form-item input, .form-item select, .form-item textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-item input:focus, .form-item select:focus, .form-item textarea:focus {
      outline: none;
      border-color: #1890ff;
      box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .help-text { font-size: 12px; color: #999; margin-top: 4px; }

    .loading { text-align: center; padding: 40px; color: #999; }
    .error { color: #ff4d4f; padding: 12px; background: #fff1f0; border-radius: 6px; margin: 10px 0; }
    .success { color: #52c41a; padding: 12px; background: #f6ffed; border-radius: 6px; margin: 10px 0; }

    .checkbox { width: 16px; height: 16px; cursor: pointer; }

    .reject-reason { color: #ff4d4f; font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>
  <!-- ä¾§è¾¹æ  -->
  <aside class="sidebar">
    <div class="logo">
      <i class="fas fa-truck-moving"></i>
      <span>ç‰©æµç®¡ç†ç³»ç»Ÿ</span>
    </div>
    <ul>
      <li><a href="/dashboard.html"><i class="fas fa-home"></i> <span>é¦–é¡µ</span></a></li>
      <li><a href="/orders.html"><i class="fas fa-tasks"></i> <span>è®¢å•ç®¡ç†</span></a></li>
      <li><a href="/customers.html"><i class="fas fa-users"></i> <span>å®¢æˆ·ç®¡ç†</span></a></li>
      <li><a href="/carriers.html"><i class="fas fa-truck"></i> <span>æ‰¿è¿å•†ç®¡ç†</span></a></li>
      <li><a href="/tenants.html"><i class="fas fa-building"></i> <span>ç§Ÿæˆ·ç®¡ç†</span></a></li>
      <li><a href="/reports.html"><i class="fas fa-chart-bar"></i> <span>æŠ¥è¡¨ç»Ÿè®¡</span></a></li>
      <li><a href="/application-list.html"><i class="fas fa-file-alt"></i> <span>å…¥é©»ç”³è¯·</span></a></li>
      <li><a href="/pricing-rules.html"><i class="fas fa-tags"></i> <span>é…ä»·ç®¡ç†</span></a></li>
      <li><a href="/violations.html"><i class="fas fa-exclamation-triangle"></i> <span>è¿è§„å¤„ç†</span></a></li>
      <li><a href="/finance.html"><i class="fas fa-yen-sign"></i> <span>è´¢åŠ¡ç®¡ç†</span></a></li>
      <li><a href="/settings.html"><i class="fas fa-cog"></i> <span>å†…éƒ¨è®¾ç½®</span></a></li>
      <li><a href="/vehicle-models.html"><i class="fas fa-car"></i> <span>è½¦å‹åº“ç»´æŠ¤</span></a></li>
      <li><a href="/map-management.html"><i class="fas fa-map-marked-alt"></i> <span>åœ°å›¾æœåŠ¡ç®¡ç†</span></a></li>
      <li><a href="/stop-points.html" class="active"><i class="fas fa-map-marker-alt"></i> <span>åœé ç‚¹ç®¡ç†</span></a></li>
      <li><a href="/vehicle-tracking.html"><i class="fas fa-location-arrow"></i> <span>è½¦è¾†ä½ç½®è¿½è¸ª</span></a></li>
    </ul>
  </aside>

  <!-- é¡¶éƒ¨æ  -->
  <header class="topbar">
    <div class="user-info">
      <span>ç®¡ç†å‘˜</span>
      <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•</a>
    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div class="main-content">
    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <div>
        <h1 style="font-size: 1.75rem; font-weight: 700; color: #1e293b; margin: 0;">ğŸ“ åœé ç‚¹ç®¡ç†</h1>
        <p style="color: #64748b; margin-top: 4px;">ç®¡ç†æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„åœé ç‚¹æ•°æ®</p>
      </div>
    </div>
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-row">
      <div class="stat-card total">
        <h3>æ€»åœé ç‚¹</h3>
        <div class="num" id="statTotal">-</div>
      </div>
      <div class="stat-card pending">
        <h3>å¾…å®¡æ‰¹</h3>
        <div class="num" id="statPending">-</div>
      </div>
      <div class="stat-card approved">
        <h3>å·²é€šè¿‡</h3>
        <div class="num" id="statApproved">-</div>
      </div>
      <div class="stat-card rejected">
        <h3>å·²é©³å›</h3>
        <div class="num" id="statRejected">-</div>
      </div>
    </div>

    <!-- å¾…å®¡æ‰¹åˆ—è¡¨ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">å¾…å®¡æ‰¹åœé ç‚¹</div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="batchApprove(true)">æ‰¹é‡é€šè¿‡</button>
          <button class="btn btn-danger" onclick="showBatchRejectModal()">æ‰¹é‡é©³å›</button>
        </div>
      </div>
      <div class="filter-row">
        <input type="text" id="pendingSearch" placeholder="æœç´¢åç§°/åœ°å€">
        <input type="text" id="pendingTenantName" placeholder="ç§Ÿæˆ·åç§°">
        <button class="btn btn-primary" onclick="loadPending()">æœç´¢</button>
      </div>
      <div id="pendingList" class="loading">åŠ è½½ä¸­...</div>
    </div>

    <!-- å…¨éƒ¨åœé ç‚¹åˆ—è¡¨ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">å…¨éƒ¨åœé ç‚¹</div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showCreateModal()">+ æ–°å¢åœé ç‚¹</button>
          <button class="btn btn-secondary" onclick="showImportModal()">æ‰¹é‡å¯¼å…¥</button>
        </div>
      </div>
      <div class="filter-row">
        <input type="text" id="search" placeholder="æœç´¢åç§°/åœ°å€">
        <select id="typeFilter">
          <option value="">å…¨éƒ¨ç±»å‹</option>
          <option value="residential">ä½å®…åŒº</option>
          <option value="commercial">å•†ä¸šåŒº</option>
          <option value="industrial">å·¥ä¸šåŒº</option>
          <option value="other">å…¶ä»–</option>
        </select>
        <select id="statusFilter">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          <option value="active">å¯ç”¨</option>
          <option value="inactive">åœç”¨</option>
        </select>
        <select id="approvalFilter">
          <option value="">å…¨éƒ¨å®¡æ‰¹çŠ¶æ€</option>
          <option value="pending">å¾…å®¡æ‰¹</option>
          <option value="approved">å·²é€šè¿‡</option>
          <option value="rejected">å·²é©³å›</option>
        </select>
        <button class="btn btn-primary" onclick="loadAll()">æœç´¢</button>
      </div>
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" class="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
            <th>ID</th>
            <th>åç§°</th>
            <th>åœ°å€</th>
            <th>ç±»å‹</th>
            <th>åŒºåŸŸ</th>
            <th>åæ ‡</th>
            <th>çŠ¶æ€</th>
            <th>å®¡æ‰¹</th>
            <th>æ¥æº</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="allList"></tbody>
      </table>
      <div class="pagination">
        <div class="pagination-info" id="paginationInfo"></div>
        <div class="pagination-btns">
          <button class="btn btn-secondary" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
          <button class="btn btn-secondary" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
  <div class="modal" id="createModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">æ–°å¢åœé ç‚¹</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-item">
            <label>åç§° *</label>
            <input type="text" id="formName" required>
          </div>
          <div class="form-item">
            <label>ç±»å‹</label>
            <select id="formType">
              <option value="other">å…¶ä»–</option>
              <option value="residential">ä½å®…åŒº</option>
              <option value="commercial">å•†ä¸šåŒº</option>
              <option value="industrial">å·¥ä¸šåŒº</option>
            </select>
          </div>
        </div>
        <div class="form-item" style="position: relative;">
          <label>åœ°å€ *</label>
          <input type="text" id="formAddress" required placeholder="è¾“å…¥å…³é”®è¯æ¨¡ç³Šæœç´¢åœ°å€">
          <div style="margin-top: 5px;">
            <button type="button" onclick="getCoordsFromAddress()" style="padding: 4px 10px; font-size: 12px; margin-right: 5px;">æ ¹æ®åœ°å€è·å–åæ ‡</button>
            <button type="button" onclick="testApiKey()" style="padding: 4px 10px; font-size: 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">æµ‹è¯• API</button>
          </div>
          <div id="searchResults" style="display:none; position:absolute; left:0; right:0; top:100%; z-index:9999; background:white; border:1px solid #d9d9d9; border-radius:4px; max-height:250px; overflow-y:auto; box-shadow:0 2px 8px rgba(0,0,0,0.15);"></div>
        </div>
        <div class="form-row">
          <div class="form-item">
            <label>çº¬åº¦ *</label>
            <input type="number" step="0.001" id="formLat" required>
            <div class="help-text">èŒƒå›´ï¼š-90 ~ 90ï¼ˆä¿ç•™ 3 ä½å°æ•°å³å¯ï¼‰</div>
          </div>
          <div class="form-item">
            <label>ç»åº¦ *</label>
            <input type="number" step="0.001" id="formLng" required>
            <div class="help-text">èŒƒå›´ï¼š-180 ~ 180ï¼ˆä¿ç•™ 3 ä½å°æ•°å³å¯ï¼‰</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-item">
            <label>åŒºåŸŸ</label>
            <input type="text" id="formRegion">
          </div>
          <div class="form-item">
            <label>å®¹é‡</label>
            <input type="number" id="formCapacity" value="1">
          </div>
        </div>
        <div class="form-item">
          <label>æè¿°</label>
          <textarea id="formDescription" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitForm()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡å¯¼å…¥å¼¹çª— -->
  <div class="modal" id="importModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ‰¹é‡å¯¼å…¥åœé ç‚¹</h3>
        <button class="modal-close" onclick="closeImportModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-item">
          <label>JSON æ•°æ®</label>
          <textarea id="importData" rows="15" placeholder='[{"name":"ç«™ç‚¹ 1","address":"åœ°å€ 1","lat":39.9,"lng":116.4,"type":"commercial","region":"åŒ—äº¬","capacity":10,"description":"æè¿°"}]'></textarea>
          <div class="help-text">æ ¼å¼ï¼šJSON æ•°ç»„ï¼Œå¿…å¡«å­—æ®µï¼šname, address, lat, lng</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitImport()">å¯¼å…¥</button>
      </div>
    </div>
  </div>

  <!-- é©³å›åŸå› å¼¹çª— -->
  <div class="modal" id="rejectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>å¡«å†™é©³å›åŸå› </h3>
        <button class="modal-close" onclick="closeRejectModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-item">
          <label>é©³å›åŸå›  *</label>
          <textarea id="rejectionReason" rows="4" required placeholder="è¯·è¯´æ˜é©³å›åŸå› "></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeRejectModal()">å–æ¶ˆ</button>
        <button class="btn btn-danger" onclick="confirmReject()">ç¡®è®¤é©³å›</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let currentPage = 1;
    let currentLimit = 20;
    let selectedIds = [];
    let editingId = null;
    let rejectCallback = null;

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
      window.location.href = '/login.html';
    }

    async function fetchApi(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${adminToken}`,
          ...options.headers
        }
      });
      return res.json();
    }

    async function loadStats() {
      try {
        const res = await fetchApi(`${API_BASE}/admin/stop-points/stats`);
        if (res.success) {
          document.getElementById('statTotal').textContent = res.data.total || 0;
          document.getElementById('statPending').textContent = res.data.pending || 0;
          document.getElementById('statApproved').textContent = res.data.approved || 0;
          document.getElementById('statRejected').textContent = res.data.rejected || 0;
        }
      } catch (err) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', err);
      }
    }

    async function loadPending() {
      const search = document.getElementById('pendingSearch').value;
      const tenantName = document.getElementById('pendingTenantName').value;
      const params = new URLSearchParams({ page: 1, limit: 10 });
      if (search) params.append('search', search);
      if (tenantName) params.append('tenantName', tenantName);

      try {
        const res = await fetchApi(`${API_BASE}/admin/stop-points/pending?${params}`);
        const container = document.getElementById('pendingList');
        if (res.success && res.data.list.length > 0) {
          container.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" class="checkbox" onchange="togglePendingSelect(this)"></th>
                  <th>ID</th>
                  <th>åç§°</th>
                  <th>åœ°å€</th>
                  <th>ç±»å‹</th>
                  <th>ä¸Šä¼ ç§Ÿæˆ·</th>
                  <th>ä¸Šä¼ æ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${res.data.list.map(sp => `
                  <tr>
                    <td><input type="checkbox" class="checkbox pending-select" value="${sp.id}"></td>
                    <td>${sp.id}</td>
                    <td>${sp.name}</td>
                    <td>${sp.address}</td>
                    <td><span class="type-badge">${sp.type || 'å…¶ä»–'}</span></td>
                    <td>${sp.tenant_name || '-'}</td>
                    <td>${new Date(sp.created_at).toLocaleString('zh-CN')}</td>
                    <td>
                      <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="approveOne(${sp.id}, true)">é€šè¿‡</button>
                        <button class="btn btn-danger btn-sm" onclick="showRejectModal(${sp.id})">é©³å›</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          container.innerHTML = '<div class="loading">æš‚æ— å¾…å®¡æ‰¹æ•°æ®</div>';
        }
      } catch (err) {
        document.getElementById('pendingList').innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
      }
    }

    async function loadAll() {
      const search = document.getElementById('search').value;
      const type = document.getElementById('typeFilter').value;
      const status = document.getElementById('statusFilter').value;
      const approvalStatus = document.getElementById('approvalFilter').value;

      const params = new URLSearchParams({
        page: currentPage,
        limit: currentLimit,
        ...(search && { search }),
        ...(type && { type }),
        ...(status && { status }),
        ...(approvalStatus && { approval_status: approvalStatus })
      });

      try {
        const res = await fetchApi(`${API_BASE}/admin/stop-points?${params}`);
        const container = document.getElementById('allList');
        if (res.success && res.data.list.length > 0) {
          container.innerHTML = res.data.list.map(sp => `
            <tr>
              <td><input type="checkbox" class="checkbox all-select" value="${sp.id}"></td>
              <td>${sp.id}</td>
              <td>${sp.name}</td>
              <td>${sp.address}</td>
              <td><span class="type-badge">${sp.type || 'å…¶ä»–'}</span></td>
              <td>${sp.region || '-'}</td>
              <td>${sp.lat.toFixed(4)}, ${sp.lng.toFixed(4)}</td>
              <td><span class="status-badge ${sp.status === 'active' ? 'status-active' : 'status-inactive'}">${sp.status === 'active' ? 'å¯ç”¨' : 'åœç”¨'}</span></td>
              <td><span class="status-badge ${sp.approval_status === 'approved' ? 'status-approved' : sp.approval_status === 'rejected' ? 'status-rejected' : 'status-pending'}">${sp.approval_status === 'approved' ? 'å·²é€šè¿‡' : sp.approval_status === 'rejected' ? 'å·²é©³å›' : 'å¾…å®¡æ‰¹'}</span></td>
              <td>${sp.upload_source === 'tenant' ? 'ç§Ÿæˆ·ä¸Šä¼ ' : 'åå°å½•å…¥'}</td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-secondary btn-sm" onclick="editStopPoint(${sp.id})">ç¼–è¾‘</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteStopPoint(${sp.id})">åˆ é™¤</button>
                </div>
              </td>
            </tr>
          `).join('');

          document.getElementById('paginationInfo').textContent =
            `ç¬¬${res.data.pagination.page} é¡µï¼Œå…±${res.data.pagination.totalPages} é¡µï¼Œæ€»è®¡ ${res.data.pagination.total} æ¡`;
        } else {
          container.innerHTML = '<tr><td colspan="11" class="loading">æš‚æ— æ•°æ®</td></tr>';
        }
      } catch (err) {
        document.getElementById('allList').innerHTML = '<tr><td colspan="11" class="error">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    function toggleSelectAll() {
      const checked = document.getElementById('selectAll').checked;
      document.querySelectorAll('.all-select').forEach(cb => cb.checked = checked);
      updateSelectedIds();
    }

    function togglePendingSelect(el) {
      const checked = el.checked;
      document.querySelectorAll('.pending-select').forEach(cb => cb.checked = checked);
    }

    function updateSelectedIds() {
      selectedIds = Array.from(document.querySelectorAll('.all-select:checked')).map(cb => parseInt(cb.value));
    }

    function showCreateModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'æ–°å¢åœé ç‚¹';
      document.getElementById('formName').value = '';
      document.getElementById('formAddress').value = '';
      document.getElementById('formLat').value = '';
      document.getElementById('formLng').value = '';
      document.getElementById('formType').value = 'other';
      document.getElementById('formRegion').value = '';
      document.getElementById('formCapacity').value = 1;
      document.getElementById('formDescription').value = '';
      document.getElementById('createModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('createModal').classList.remove('show');
    }

    function showImportModal() {
      document.getElementById('importModal').classList.add('show');
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('show');
    }

    async function editStopPoint(id) {
      editingId = id;
      try {
        const res = await fetchApi(`${API_BASE}/admin/stop-points/${id}`);
        if (res.success) {
          const sp = res.data;
          document.getElementById('modalTitle').textContent = 'ç¼–è¾‘åœé ç‚¹';
          document.getElementById('formName').value = sp.name;
          document.getElementById('formAddress').value = sp.address;
          document.getElementById('formLat').value = sp.lat;
          document.getElementById('formLng').value = sp.lng;
          document.getElementById('formType').value = sp.type || 'other';
          document.getElementById('formRegion').value = sp.region || '';
          document.getElementById('formCapacity').value = sp.capacity || 1;
          document.getElementById('formDescription').value = sp.description || '';
          document.getElementById('createModal').classList.add('show');
        }
      } catch (err) {
        alert('åŠ è½½å¤±è´¥');
      }
    }

    async function submitForm() {
      const data = {
        name: document.getElementById('formName').value,
        address: document.getElementById('formAddress').value,
        lat: parseFloat(document.getElementById('formLat').value),
        lng: parseFloat(document.getElementById('formLng').value),
        type: document.getElementById('formType').value,
        region: document.getElementById('formRegion').value,
        capacity: parseInt(document.getElementById('formCapacity').value),
        description: document.getElementById('formDescription').value
      };

      if (!data.name || !data.address || !data.lat || !data.lng) {
        alert('è¯·å¡«å†™å¿…å¡«å­—æ®µ');
        return;
      }

      if (data.lat < -90 || data.lat > 90 || data.lng < -180 || data.lng > 180) {
        alert('åæ ‡è¶…å‡ºæœ‰æ•ˆèŒƒå›´');
        return;
      }

      try {
        const url = editingId ? `${API_BASE}/admin/stop-points/${editingId}` : `${API_BASE}/admin/stop-points`;
        const method = editingId ? 'PUT' : 'POST';
        const res = await fetchApi(url, { method, body: JSON.stringify(data) });

        if (res.success) {
          alert(editingId ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ');
          closeModal();
          loadAll();
          loadStats();
        } else {
          alert(res.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (err) {
        alert('æ“ä½œå¤±è´¥');
      }
    }

    async function submitImport() {
      try {
        const stopPoints = JSON.parse(document.getElementById('importData').value);
        const res = await fetchApi(`${API_BASE}/admin/stop-points/batch-import`, {
          method: 'POST',
          body: JSON.stringify({ stopPoints })
        });

        if (res.success) {
          alert(res.message);
          closeImportModal();
          loadAll();
          loadStats();
        } else {
          alert(res.message || 'å¯¼å…¥å¤±è´¥');
        }
      } catch (err) {
        alert('JSON æ ¼å¼é”™è¯¯');
      }
    }

    async function deleteStopPoint(id) {
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥åœé ç‚¹ï¼Ÿ')) return;
      try {
        const res = await fetchApi(`${API_BASE}/admin/stop-points/${id}`, { method: 'DELETE' });
        if (res.success) {
          alert('åˆ é™¤æˆåŠŸ');
          loadAll();
          loadStats();
        } else {
          alert(res.message || 'åˆ é™¤å¤±è´¥');
        }
      } catch (err) {
        alert('åˆ é™¤å¤±è´¥');
      }
    }

    function showRejectModal(id) {
      rejectCallback = id;
      document.getElementById('rejectionReason').value = '';
      document.getElementById('rejectModal').classList.add('show');
    }

    function closeRejectModal() {
      document.getElementById('rejectModal').classList.remove('show');
      rejectCallback = null;
    }

    function showBatchRejectModal() {
      const checkboxes = document.querySelectorAll('.pending-select:checked');
      const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
      if (ids.length === 0) {
        alert('è¯·é€‰æ‹©è¦é©³å›çš„åœé ç‚¹');
        return;
      }
      rejectCallback = ids;
      document.getElementById('rejectionReason').value = '';
      document.getElementById('rejectModal').classList.add('show');
    }

    async function confirmReject() {
      const reason = document.getElementById('rejectionReason').value;
      if (!reason) {
        alert('è¯·å¡«å†™é©³å›åŸå› ');
        return;
      }

      try {
        if (Array.isArray(rejectCallback)) {
          // æ‰¹é‡é©³å›
          const res = await fetchApi(`${API_BASE}/admin/stop-points/batch-approve`, {
            method: 'POST',
            body: JSON.stringify({ ids: rejectCallback, approved: false, rejectionReason: reason })
          });
          if (res.success) {
            alert(`å·²é©³å›${res.data.successIds.length} æ¡`);
            closeRejectModal();
            loadPending();
            loadStats();
          } else {
            alert(res.message || 'æ“ä½œå¤±è´¥');
          }
        } else {
          // å•ä¸ªé©³å›
          const res = await fetchApi(`${API_BASE}/admin/stop-points/${rejectCallback}/approve`, {
            method: 'POST',
            body: JSON.stringify({ approved: false, rejectionReason: reason })
          });
          if (res.success) {
            alert('å·²é©³å›');
            closeRejectModal();
            loadPending();
            loadStats();
          } else {
            alert(res.message || 'æ“ä½œå¤±è´¥');
          }
        }
      } catch (err) {
        alert('æ“ä½œå¤±è´¥');
      }
    }

    async function approveOne(id, approved) {
      if (!approved && !confirm('ç¡®è®¤é©³å›ï¼Ÿ')) return;
      try {
        const res = await fetchApi(`${API_BASE}/admin/stop-points/${id}/approve`, {
          method: 'POST',
          body: JSON.stringify({ approved, rejectionReason: approved ? null : 'æ— ' })
        });
        if (res.success) {
          alert(approved ? 'å·²é€šè¿‡' : 'å·²é©³å›');
          loadPending();
          loadStats();
        } else {
          alert(res.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (err) {
        alert('æ“ä½œå¤±è´¥');
      }
    }

    async function batchApprove(approved) {
      const checkboxes = document.querySelectorAll('.pending-select:checked');
      const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
      if (ids.length === 0) {
        alert('è¯·é€‰æ‹©è¦å®¡æ‰¹çš„åœé ç‚¹');
        return;
      }
      if (!approved && !confirm('ç¡®è®¤æ‰¹é‡é©³å›ï¼Ÿ')) return;

      try {
        const res = await fetchApi(`${API_BASE}/admin/stop-points/batch-approve`, {
          method: 'POST',
          body: JSON.stringify({ ids, approved, rejectionReason: approved ? null : 'æ‰¹é‡é©³å›' })
        });
        if (res.success) {
          alert(approved ? `å·²é€šè¿‡ ${res.data.successIds.length} æ¡` : `å·²é©³å›${res.data.successIds.length} æ¡`);
          loadPending();
          loadStats();
        } else {
          alert(res.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (err) {
        alert('æ“ä½œå¤±è´¥');
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        loadAll();
      }
    }

    function nextPage() {
      currentPage++;
      loadAll();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      window.location.href = '/login.html';
    }

    // åˆå§‹åŒ–
    loadStats();
    loadPending();
    loadAll();
    initAddressSearch();

    // åˆå§‹åŒ–åœ°å€æœç´¢
    function initAddressSearch() {
      const input = document.getElementById('formAddress');
      const panel = document.getElementById('searchResults');
      console.log('[INIT] input:', input, 'panel:', panel);
      if (!input || !panel) {
        console.error('[INIT] å…ƒç´ ä¸å­˜åœ¨!');
        return;
      }
      console.log('[INIT] åœ°å€æœç´¢åˆå§‹åŒ–æˆåŠŸ');

      let timer;
      input.addEventListener('input', () => {
        const keyword = input.value.trim();
        console.log('[INPUT] è¾“å…¥:', keyword);
        clearTimeout(timer);
        timer = setTimeout(() => {
          console.log('[SEARCH] å¼€å§‹æœç´¢:', keyword);
          if (keyword) searchPlaces(keyword, panel);
          else panel.style.display = 'none';
        }, 300);
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('#formAddress') && !e.target.closest('#searchResults')) {
          panel.style.display = 'none';
        }
      });
    }

    // æ ¹æ®åœ°å€è·å–åæ ‡
    function getCoordsFromAddress() {
      const address = document.getElementById('formAddress').value.trim();
      console.log('[GEO] åœ°å€:', address);
      if (!address) { alert('è¯·å…ˆè¾“å…¥åœ°å€'); return; }
      jsonpRequest('geocoder', address);
    }

    // æ¨¡ç³Šæœç´¢
    function searchPlaces(keyword, panel) {
      console.log('[SEARCH] searchPlaces è°ƒç”¨:', keyword);
      jsonpRequest('search', keyword, panel);
    }

    // JSONP è¯·æ±‚
    function jsonpRequest(type, keyword, panel) {
      const KEY = 'C66BZ-TKWWW-MWJR2-Y4BT5-5IQXJ-2EBBJ';
      const callbackName = 'cb_' + Date.now();
      const urls = {
        geocoder: 'https://apis.map.qq.com/ws/geocoder/v1/',
        search: 'https://apis.map.qq.com/ws/place/v1/suggestion/'
      };
      const fullUrl = `${urls[type]}?${type === 'geocoder' ? 'address=' : 'keyword='}${encodeURIComponent(keyword)}&key=${KEY}&callback=${callbackName}`;
      console.log('[JSONP] URL:', fullUrl);

      window[callbackName] = function(data) {
        console.log('[JSONP] å›è°ƒæ•°æ®:', data);
        delete window[callbackName];
        const script = document.getElementById('s_' + callbackName);
        if (script) script.remove();

        if (type === 'geocoder') {
          if (data.status === 0 && data.result?.location) {
            document.getElementById('formLat').value = data.result.location.lat.toFixed(3);
            document.getElementById('formLng').value = data.result.location.lng.toFixed(3);
            alert('åæ ‡å·²è‡ªåŠ¨å¡«å……ï¼');
          } else {
            alert('æœªæ‰¾åˆ°è¯¥åœ°å€ï¼š' + (data.message || ''));
          }
        } else if (type === 'search' && panel) {
          if (data.status === 0 && data.data && data.data.length > 0) {
            let html = '';
            data.data.forEach(item => {
              const addr = (item.address || item.title).replace(/'/g, "\\'");
              const title = item.title.replace(/'/g, "\\'");
              const lat = item.location.lat;
              const lng = item.location.lng;
              html += `<div onclick="fillAddress('${addr}', ${lat}, ${lng})" style="padding:8px;cursor:pointer;border-bottom:1px solid #f0f0f0;">` +
                `<strong>${title}</strong><br><small style="color:#666;">${item.address || ''}</small></div>`;
            });
            panel.innerHTML = html;
            panel.style.display = 'block';
            console.log('[SEARCH] æ˜¾ç¤º', data.data.length, 'æ¡ç»“æœ');
          } else {
            panel.style.display = 'none';
            console.log('[SEARCH] æ— ç»“æœï¼Œstatus:', data.status);
          }
        }
      };

      const script = document.createElement('script');
      script.id = 's_' + callbackName;
      script.src = fullUrl;
      script.onerror = () => { 
        console.error('[JSONP] åŠ è½½å¤±è´¥'); 
        console.error('[JSONP] å¯èƒ½åŸå› ï¼š1.ç½‘ç»œä¸é€š 2.API Key é…é¢ç”¨å®Œ 3.é˜²ç«å¢™æ‹¦æˆª');
        console.error('[JSONP] è¯·åœ¨æµè§ˆå™¨ç›´æ¥æµ‹è¯•ï¼šhttps://apis.map.qq.com/ws/place/v1/suggestion/?keyword=åŒ—äº¬&key=C66BZ-TKWWW-MWJR2-Y4BT5-5IQXJ-2EBBJ');
        delete window[callbackName]; 
        script.remove(); 
      };
      script.onload = () => { console.log('[JSONP] è„šæœ¬åŠ è½½æˆåŠŸ'); };
      document.body.appendChild(script);
      console.log('[JSONP] è„šæœ¬å·²æ·»åŠ ');
    }

    // å¡«å……åœ°å€
    function fillAddress(address, lat, lng) {
      console.log('[FILL] å¡«å……åœ°å€:', address, lat, lng);
      document.getElementById('formAddress').value = address;
      document.getElementById('formLat').value = lat.toFixed(3);
      document.getElementById('formLng').value = lng.toFixed(3);
      document.getElementById('searchResults').style.display = 'none';
    }

    // æµ‹è¯• API Key
    function testApiKey() {
      const KEY = 'C66BZ-TKWWW-MWJR2-Y4BT5-5IQXJ-2EBBJ';
      const callbackName = 'testcb_' + Date.now();
      console.log('[TEST] å¼€å§‹æµ‹è¯• API Key');
      window[callbackName] = function(data) {
        console.log('[TEST] è¿”å›:', data);
        delete window[callbackName];
        document.getElementById('s_' + callbackName)?.remove();
        if (data.status === 0) {
          alert('API Key æœ‰æ•ˆï¼è¿”å› ' + (data.data?.length || 0) + ' æ¡ç»“æœ');
        } else {
          alert('API Key æ— æ•ˆï¼š' + data.message);
        }
      };
      const script = document.createElement('script');
      script.id = 's_' + callbackName;
      script.src = `https://apis.map.qq.com/ws/place/v1/suggestion/?keyword=åŒ—äº¬&key=${KEY}&callback=${callbackName}`;
      script.onerror = () => { delete window[callbackName]; script.remove(); alert('ç½‘ç»œè¯·æ±‚å¤±è´¥'); };
      document.body.appendChild(script);
      console.log('[TEST] è„šæœ¬å·²æ·»åŠ ');
    }
  </script>
  </div> <!-- ç»“æŸ main-content -->
</body>
</html>
