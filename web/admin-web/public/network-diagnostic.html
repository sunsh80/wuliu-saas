<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¿æ¥è¯Šæ–­ - ç‰©æµç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .diagnostic-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border-left: 4px solid #3b82f6;
        }
        
        .diagnostic-card.success {
            border-left-color: #10b981;
        }
        
        .diagnostic-card.error {
            border-left-color: #ef4444;
        }
        
        .diagnostic-card.warning {
            border-left-color: #f59e0b;
        }
        
        .diagnostic-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 10px 0;
        }
        
        .diagnostic-details {
            color: #64748b;
            margin: 0;
            line-height: 1.6;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px 5px 5px 0;
        }
        
        .btn:hover {
            background-color: #2563eb;
        }
        
        .btn-success {
            background-color: #10b981;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-error {
            background-color: #ef4444;
        }
        
        .btn-error:hover {
            background-color: #dc2626;
        }
        
        .btn-warning {
            background-color: #f59e0b;
        }
        
        .btn-warning:hover {
            background-color: #d97706;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }
        
        .hidden {
            display: none;
        }
        
        .step {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8fafc;
            border-radius: 6px;
        }
        
        .step-title {
            font-weight: 600;
            color: #334155;
            margin-bottom: 5px;
        }
        
        .step-content {
            color: #64748b;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç½‘ç»œè¿æ¥è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨äºè¯Šæ–­å‰ç«¯ä¸åç«¯æœåŠ¡å™¨çš„è¿æ¥é—®é¢˜</p>
        
        <button class="btn" onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <button class="btn btn-warning" onclick="checkBackendHealth()">æ£€æŸ¥åç«¯å¥åº·</button>
        <button class="btn" onclick="checkProxyConfiguration()">æ£€æŸ¥ä»£ç†é…ç½®</button>
        <button class="btn" onclick="testApiEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
        
        <div id="connection-status" class="diagnostic-card">
            <h3 class="diagnostic-title">è¿æ¥çŠ¶æ€</h3>
            <p id="connection-details" class="diagnostic-details">ç­‰å¾…è¯Šæ–­...</p>
        </div>
        
        <div id="diagnostic-steps" class="diagnostic-card hidden">
            <h3 class="diagnostic-title">è¯Šæ–­æ­¥éª¤</h3>
            <div id="steps-content"></div>
        </div>
        
        <div id="solutions" class="diagnostic-card hidden">
            <h3 class="diagnostic-title">å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ</h3>
            <div id="solutions-content"></div>
        </div>
    </div>

    <script>
        // æœåŠ¡å™¨é…ç½®
        const BACKEND_URL = 'http://localhost:3000';
        const API_BASE = '/api';
        
        // è¿è¡Œå®Œæ•´è¯Šæ–­
        async function runFullDiagnostic() {
            const statusDiv = document.getElementById('connection-details');
            statusDiv.textContent = 'æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...';
            
            document.getElementById('diagnostic-steps').classList.remove('hidden');
            document.getElementById('solutions').classList.add('hidden');
            
            const stepsContent = document.getElementById('steps-content');
            stepsContent.innerHTML = '';
            
            // æ­¥éª¤1: æ£€æŸ¥åŸºæœ¬è¿é€šæ€§
            addStep('æ­¥éª¤ 1: æ£€æŸ¥åç«¯æœåŠ¡å™¨è¿é€šæ€§', 'å°è¯•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨...');
            const healthCheck = await checkBackendHealth(true);
            
            // æ­¥éª¤2: æ£€æŸ¥APIä»£ç†
            addStep('æ­¥éª¤ 2: æ£€æŸ¥APIä»£ç†é…ç½®', 'éªŒè¯å‰ç«¯ä»£ç†æ˜¯å¦æ­£ç¡®è½¬å‘è¯·æ±‚...');
            const proxyCheck = await checkProxyConfiguration(true);
            
            // æ­¥éª¤3: æµ‹è¯•APIç«¯ç‚¹
            addStep('æ­¥éª¤ 3: æµ‹è¯•APIç«¯ç‚¹', 'æµ‹è¯•å…³é”®APIç«¯ç‚¹æ˜¯å¦å¯è®¿é—®...');
            const apiCheck = await testApiEndpoints(true);
            
            // æ±‡æ€»ç»“æœ
            if (healthCheck && proxyCheck && apiCheck) {
                statusDiv.innerHTML = '<strong style="color: #10b981;">âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼è¿æ¥æ­£å¸¸</strong>';
                document.getElementById('connection-status').className = 'diagnostic-card success';
            } else {
                statusDiv.innerHTML = '<strong style="color: #ef4444;">âŒ å‘ç°è¿æ¥é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹è¯Šæ–­è¯¦æƒ…</strong>';
                document.getElementById('connection-status').className = 'diagnostic-card error';
                
                // æä¾›è§£å†³æ–¹æ¡ˆ
                provideSolutions(!healthCheck, !proxyCheck, !apiCheck);
            }
        }
        
        // æ£€æŸ¥åç«¯å¥åº·
        async function checkBackendHealth(silent = false) {
            if (!silent) {
                const statusDiv = document.getElementById('connection-details');
                statusDiv.textContent = 'æ­£åœ¨æ£€æŸ¥åç«¯æœåŠ¡å™¨å¥åº·çŠ¶æ€...';
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶
                
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    if (!silent) {
                        document.getElementById('connection-details').innerHTML = `
                            <strong style="color: #10b981;">âœ… åç«¯æœåŠ¡å™¨è¿æ¥æ­£å¸¸</strong><br>
                            çŠ¶æ€: ${data.status || 'OK'}<br>
                            å“åº”æ—¶é—´: ${response.responseTime || 'N/A'}ms
                        `;
                        document.getElementById('connection-status').className = 'diagnostic-card success';
                    }
                    if (!silent) addStep('åç«¯æœåŠ¡å™¨å¥åº·æ£€æŸ¥', `âœ… è¿æ¥æˆåŠŸ - çŠ¶æ€: ${data.status || 'OK'}`, 'success');
                    return true;
                } else {
                    if (!silent) addStep('åç«¯æœåŠ¡å™¨å¥åº·æ£€æŸ¥', `âŒ HTTPé”™è¯¯ - çŠ¶æ€ç : ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('åç«¯å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                if (!silent) {
                    document.getElementById('connection-details').innerHTML = `
                        <strong style="color: #ef4444;">âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨</strong><br>
                        é”™è¯¯: ${error.message}<br>
                        è¯·ç¡®è®¤åç«¯æœåŠ¡æ˜¯å¦åœ¨ ${BACKEND_URL} è¿è¡Œ
                    `;
                    document.getElementById('connection-status').className = 'diagnostic-card error';
                }
                if (!silent) addStep('åç«¯æœåŠ¡å™¨å¥åº·æ£€æŸ¥', `âŒ è¿æ¥å¤±è´¥ - ${error.message}`, 'error');
                return false;
            }
        }
        
        // æ£€æŸ¥ä»£ç†é…ç½®
        async function checkProxyConfiguration(silent = false) {
            if (!silent) addStep('ä»£ç†é…ç½®æ£€æŸ¥', 'éªŒè¯å‰ç«¯å¼€å‘æœåŠ¡å™¨ä»£ç†è®¾ç½®...');
            
            try {
                // å°è¯•é€šè¿‡å‰ç«¯ä»£ç†è®¿é—®åç«¯
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (!silent) addStep('ä»£ç†é…ç½®æ£€æŸ¥', `âœ… ä»£ç†é…ç½®æ­£ç¡® - çŠ¶æ€: ${data.status || 'OK'}`, 'success');
                    return true;
                } else {
                    if (!silent) addStep('ä»£ç†é…ç½®æ£€æŸ¥', `âŒ ä»£ç†é…ç½®é—®é¢˜ - çŠ¶æ€ç : ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('ä»£ç†é…ç½®æ£€æŸ¥å¤±è´¥:', error);
                if (!silent) addStep('ä»£ç†é…ç½®æ£€æŸ¥', `âŒ ä»£ç†é…ç½®é—®é¢˜ - ${error.message}`, 'error');
                return false;
            }
        }
        
        // æµ‹è¯•APIç«¯ç‚¹
        async function testApiEndpoints(silent = false) {
            if (!silent) addStep('APIç«¯ç‚¹æµ‹è¯•', 'æµ‹è¯•å…³é”®APIç«¯ç‚¹æ˜¯å¦å¯è®¿é—®...');
            
            const endpoints = [
                { url: '/api/admin/login', method: 'OPTIONS', desc: 'ç™»å½•ç«¯ç‚¹' },
                { url: '/api/admin/orders', method: 'OPTIONS', desc: 'è®¢å•ç«¯ç‚¹' },
                { url: '/api/admin/tenants', method: 'OPTIONS', desc: 'ç§Ÿæˆ·ç«¯ç‚¹' }
            ];
            
            let allPassed = true;
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const success = response.ok || response.status === 404 || response.status === 405;
                    results.push({
                        endpoint: endpoint.desc,
                        url: endpoint.url,
                        status: response.status,
                        success: success
                    });
                    
                    if (!success) {
                        allPassed = false;
                    }
                } catch (error) {
                    results.push({
                        endpoint: endpoint.desc,
                        url: endpoint.url,
                        status: 'ERROR',
                        success: false,
                        error: error.message
                    });
                    allPassed = false;
                }
            }
            
            if (!silent) {
                let resultHtml = '<div style="margin-top: 10px;">';
                results.forEach(result => {
                    const statusColor = result.success ? '#10b981' : '#ef4444';
                    const statusIcon = result.success ? 'âœ…' : 'âŒ';
                    resultHtml += `<div style="margin: 5px 0; color: ${statusColor};">${statusIcon} ${result.endpoint}: ${result.status}</div>`;
                });
                resultHtml += '</div>';
                
                addStep('APIç«¯ç‚¹æµ‹è¯•', `å®Œæˆ - ${results.filter(r => r.success).length}/${results.length} ä¸ªç«¯ç‚¹æ­£å¸¸`, allPassed ? 'success' : 'error');
                if (!allPassed) {
                    addStep('', resultHtml, 'error');
                }
            }
            
            return allPassed;
        }
        
        // æ·»åŠ è¯Šæ–­æ­¥éª¤
        function addStep(title, content, status = '') {
            const stepsContent = document.getElementById('steps-content');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${status}`;
            stepDiv.innerHTML = `
                <div class="step-title">${title}</div>
                <div class="step-content">${content}</div>
            `;
            stepsContent.appendChild(stepDiv);
        }
        
        // æä¾›è§£å†³æ–¹æ¡ˆ
        function provideSolutions(backendIssue, proxyIssue, apiIssue) {
            const solutionsContent = document.getElementById('solutions-content');
            solutionsContent.innerHTML = '';
            
            document.getElementById('solutions').classList.remove('hidden');
            
            if (backendIssue) {
                const solutionDiv = document.createElement('div');
                solutionDiv.className = 'step error';
                solutionDiv.innerHTML = `
                    <div class="step-title">ğŸ”§ åç«¯æœåŠ¡å™¨é—®é¢˜è§£å†³æ–¹æ¡ˆ</div>
                    <div class="step-content">
                        <strong>é—®é¢˜:</strong> æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨<br><br>
                        <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                        1. ç¡®è®¤åç«¯æœåŠ¡æ˜¯å¦åœ¨ç«¯å£ 3000 ä¸Šè¿è¡Œ<br>
                        2. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡º<br>
                        3. éªŒè¯é˜²ç«å¢™è®¾ç½®æ˜¯å¦é˜»æ­¢äº†ç«¯å£ 3000<br>
                        4. å°è¯•ç›´æ¥è®¿é—® http://localhost:3000/health ç¡®è®¤æœåŠ¡çŠ¶æ€<br>
                        5. æ£€æŸ¥åç«¯æœåŠ¡é…ç½®ï¼Œç¡®ä¿ç›‘å¬æ­£ç¡®çš„ä¸»æœºå’Œç«¯å£
                    </div>
                `;
                solutionsContent.appendChild(solutionDiv);
            }
            
            if (proxyIssue) {
                const solutionDiv = document.createElement('div');
                solutionDiv.className = 'step error';
                solutionDiv.innerHTML = `
                    <div class="step-title">ğŸ”§ ä»£ç†é…ç½®é—®é¢˜è§£å†³æ–¹æ¡ˆ</div>
                    <div class="step-content">
                        <strong>é—®é¢˜:</strong> å‰ç«¯ä»£ç†é…ç½®ä¸æ­£ç¡®<br><br>
                        <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                        1. æ£€æŸ¥ vite.config.js ä¸­çš„ä»£ç†é…ç½®<br>
                        2. ç¡®è®¤ä»£ç†ç›®æ ‡è®¾ç½®ä¸º http://localhost:3000<br>
                        3. éªŒè¯ä»£ç†é‡å†™è§„åˆ™æ˜¯å¦æ­£ç¡®<br>
                        4. é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨ä»¥åº”ç”¨é…ç½®æ›´æ”¹
                    </div>
                `;
                solutionsContent.appendChild(solutionDiv);
            }
            
            if (apiIssue) {
                const solutionDiv = document.createElement('div');
                solutionDiv.className = 'step error';
                solutionDiv.innerHTML = `
                    <div class="step-title">ğŸ”§ APIç«¯ç‚¹é—®é¢˜è§£å†³æ–¹æ¡ˆ</div>
                    <div class="step-content">
                        <strong>é—®é¢˜:</strong> APIç«¯ç‚¹æ— æ³•è®¿é—®<br><br>
                        <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                        1. ç¡®è®¤åç«¯APIè·¯ç”±æ˜¯å¦æ­£ç¡®å®šä¹‰<br>
                        2. æ£€æŸ¥CORSé…ç½®æ˜¯å¦å…è®¸å‰ç«¯åŸŸåè®¿é—®<br>
                        3. éªŒè¯APIç«¯ç‚¹è·¯å¾„æ˜¯å¦æ­£ç¡®<br>
                        4. æŸ¥çœ‹åç«¯æ—¥å¿—ä»¥è·å–æ›´å¤šé”™è¯¯ä¿¡æ¯
                    </div>
                `;
                solutionsContent.appendChild(solutionDiv);
            }
            
            if (!backendIssue && !proxyIssue && !apiIssue) {
                const solutionDiv = document.createElement('div');
                solutionDiv.className = 'step success';
                solutionDiv.innerHTML = `
                    <div class="step-title">âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡</div>
                    <div class="step-content">
                        è¿æ¥é…ç½®æ­£å¸¸ï¼Œå¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥:<br>
                        1. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯<br>
                        2. ç½‘ç»œè¯·æ±‚æ˜¯å¦è¿”å›é¢„æœŸå“åº”<br>
                        3. è®¤è¯ä»¤ç‰Œæ˜¯å¦æ­£ç¡®è®¾ç½®
                    </div>
                `;
                solutionsContent.appendChild(solutionDiv);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æç¤º
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('connection-details').innerHTML = `
                <strong>ğŸ’¡ æç¤º:</strong> ç‚¹å‡»"è¿è¡Œå®Œæ•´è¯Šæ–­"æŒ‰é’®å¼€å§‹æ£€æŸ¥è¿æ¥é—®é¢˜<br>
                ç¡®ä¿åç«¯æœåŠ¡åœ¨ <code>http://localhost:3000</code> è¿è¡Œ
            `;
        });
    </script>
</body>
</html>