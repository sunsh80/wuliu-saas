<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC Admin Dashboard</title>
    <!-- 引入 CSS 文件 -->
    <link rel="stylesheet" href="/admin/css/style.css">
    <style>
        /* 内嵌基础样式，也可以放在单独的 CSS 文件中 */
        .hidden { display: none; }
        .error { color: red; }
        .success { color: green; }
        .btn { padding: 5px 10px; margin: 2px; cursor: pointer; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .update-status-btn { padding: 5px 10px; margin-left: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        nav a { margin-right: 15px; text-decoration: none; color: blue; }
        nav a:hover { text-decoration: underline; }
        section { margin-bottom: 30px; }
        #message, #loginMessage { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <!-- 登录区域 -->
    <div id="loginSection" class="hidden">
        <h2>管理员登录</h2>
        <form id="loginForm">
            <div>
                <label for="username">用户名:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div>
                <label for="password">密码:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit">登录</button>
        </form>
        <div id="loginMessage"></div>
    </div>

    <!-- 主内容区域 -->
    <div id="mainSection" class="hidden">
        <h1>PC Admin Dashboard</h1>
        <p>
            <span>管理员</span>
            <button id="logoutButton">登出</button>
        </p>

        <nav>
            <a href="#tenants">租户管理</a>
            <a href="#orders">订单管理</a>
            <a href="#applications">入驻申请</a>
        </nav>

        <section id="tenants">
            <h2>租户管理</h2>
            <button onclick="loadApprovedTenants()">刷新（已激活租户）</button> <!-- 假设函数存在 -->
            <p>（此处可扩展为展示已激活租户列表）</p>
            <table border="1" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>租户名称</th>
                        <th>联系人</th>
                        <th>联系电话</th>
                        <th>状态</th>
                        <th>注册时间</th>
                        <!-- <th>操作</th> 可能需要根据需求添加 -->
                    </tr>
                </thead>
                <tbody id="approved-tenants-body">
                    <!-- 动态加载已批准租户 -->
                </tbody>
            </table>
        </section>

        <section id="applications">
            <h2>入驻申请</h2>
            <button onclick="loadPendingTenants()">刷新（待审核）</button>
            <table border="1" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>租户名称</th>
                        <th>联系人</th>
                        <th>联系电话</th>
                        <th>申请时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="pending-tenants-body">
                    <tr id="no-pending-tenants-message">
                        <td colspan="6">暂无待审核租户</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="orders">
            <h2>订单管理</h2>
            <button onclick="loadAllOrders()">刷新（所有订单）</button>
            <table border="1" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>订单号</th>
                        <th>客户姓名</th>
                        <th>客户电话</th>
                        <th>取货地址</th>
                        <th>重量 (kg)</th>
                        <th>体积 (m³)</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>更新状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="all-orders-body">
                    <!-- 动态加载订单 -->
                </tbody>
            </table>
        </section>

        <div id="message"></div>
    </div>

    <!-- 引入 JS 文件 -->
    <script src="/admin/js/main.js"></script> <!-- 必须首先引入 -->
    <script>
        // --- 通用逻辑 (从 script.js 整合而来) ---
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');

        function showLoginSection() {
            loginSection.classList.remove('hidden');
            mainSection.classList.add('hidden');
        }

        function showMainSection() {
            loginSection.classList.add('hidden');
            mainSection.classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('adminToken');
            showLoginSection();
        }

        function showMessage(text, isError = false) {
            const msgDiv = document.getElementById('message');
            if (msgDiv) {
                msgDiv.textContent = text;
                msgDiv.className = isError ? 'error' : 'success';
            } else {
                alert(text);
            }
        }

        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                loginMessage.textContent = '用户名和密码不能为空';
                loginMessage.className = 'error';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('adminToken', data.token);
                    loginMessage.textContent = '登录成功！';
                    loginMessage.className = 'success';
                    setTimeout(() => showMainSection(), 500); // 延迟一下，让用户看到成功消息
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    loginMessage.textContent = errorData.message || errorData.error || '登录失败';
                    loginMessage.className = 'error';
                }
            } catch (error) {
                console.error('登录请求失败:', error);
                loginMessage.textContent = '网络错误，请稍后重试';
                loginMessage.className = 'error';
            }
        }

        function checkStoredToken() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                // Token 存在，尝试访问受保护资源验证有效性
                // 这里简单起见，直接显示主界面，如果 API 返回 401，main.js 会处理跳转
                showMainSection();
            } else {
                showLoginSection();
            }
        }

        // --- 待审核租户逻辑 (从 tenantList.js 整合而来) ---
        async function loadPendingTenants() {
            try {
                const response = await apiRequest('/admin/tenants/pending');
                const tenants = response.data; // OpenAPI 返回格式 { data: [...] }

                const tbody = document.getElementById('pending-tenants-body');
                const noTenantsMsg = document.getElementById('no-pending-tenants-message');

                if (!Array.isArray(tenants)) {
                    throw new Error('服务器返回的数据格式不正确');
                }

                if (tenants.length === 0) {
                    tbody.innerHTML = '';
                    noTenantsMsg.style.display = 'table-row';
                    return;
                }

                noTenantsMsg.style.display = 'none';
                tbody.innerHTML = '';

                tenants.forEach(tenant => {
                    const row = document.createElement('tr');
                    const createdAt = new Date(tenant.created_at).toLocaleString();
                    row.innerHTML = `
                        <td>${tenant.id}</td>
                        <td>${tenant.name}</td>
                        <td>${tenant.contact_person}</td>
                        <td>${tenant.contact_phone}</td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-success" onclick="approveTenant(${tenant.id})">通过</button>
                            <button class="btn btn-danger" onclick="rejectTenantPrompt(${tenant.id})">拒绝</button>
                            <button class="btn btn-info" onclick="viewTenantDetails(${tenant.id})">查看附件</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('加载待审核租户失败:', error);
                showMessage(`加载失败: ${error.message}`, true);
                document.getElementById('pending-tenants-body').innerHTML = `<tr><td colspan="6">加载失败，请刷新重试。</td></tr>`;
            }
        }

        async function approveTenant(id) {
            if (!confirm(`确定通过租户 ID: ${id} 的申请吗？`)) return;
            try {
                await apiRequest(`/admin/tenants/${id}/approve`, {
                    method: 'PUT',
                    body: { roles: ["customer", "carrier"] } // 示例角色分配
                });
                showMessage('申请已通过', false);
                loadPendingTenants(); // 刷新列表
            } catch (error) {
                console.error('通过申请失败:', error);
                showMessage(`操作失败: ${error.message}`, true);
            }
        }

        async function rejectTenantPrompt(id) {
            const notes = prompt('请输入拒绝原因:');
            if (notes === null || notes.trim() === '') return;
            try {
                await apiRequest(`/admin/tenants/${id}/reject`, {
                    method: 'PUT',
                    body: { notes: notes.trim() }
                });
                showMessage('申请已拒绝', false);
                loadPendingTenants(); // 刷新列表
            } catch (error) {
                console.error('拒绝申请失败:', error);
                showMessage(`操作失败: ${error.message}`, true);
            }
        }

        function viewTenantDetails(id) {
            // TODO: 实现查看附件功能
            alert(`查看租户 ${id} 的附件详情功能待实现。`);
        }

        // --- 订单逻辑 (从 orderList.js 整合而来) ---
        async function loadAllOrders() {
            try {
                const response = await apiRequest('/admin/orders');
                const orders = response.data; // OpenAPI 返回格式 { data: [...] }

                displayOrders(orders);
            } catch (error) {
                console.error('加载订单失败:', error);
                showMessage(`加载订单失败: ${error.message}`, true);
            }
        }

        function displayOrders(orders) {
            if (!Array.isArray(orders)) {
                throw new Error('服务器返回的数据格式不正确');
            }
            const tbody = document.getElementById('all-orders-body');
            tbody.innerHTML = ''; // 清空现有内容

            orders.forEach(order => {
                const row = tbody.insertRow();
                row.setAttribute('data-order-id', order.id);

                row.insertCell(0).textContent = order.id;
                row.insertCell(1).textContent = order.order_number || 'N/A';
                row.insertCell(2).textContent = order.customer_name || 'N/A';
                row.insertCell(3).textContent = order.customer_phone || 'N/A';
                row.insertCell(4).textContent = order.pickup_address || 'N/A';
                row.insertCell(5).textContent = order.weight_kg || 'N/A';
                row.insertCell(6).textContent = order.volume_m3 || 'N/A';
                row.insertCell(7).textContent = order.status || 'unknown';

                const createdAt = new Date(order.created_at).toLocaleString();
                row.insertCell(8).textContent = createdAt;

                const statusCell = row.insertCell(9);
                const statusSelect = document.createElement('select');
                statusSelect.className = 'status-select';
                statusSelect.setAttribute('data-order-id', order.id);

                const statusOptions = [
                    { value: 'created', label: '待处理' },
                    { value: 'claimed', label: '已认领' },
                    { value: 'awarded', label: '已成交' },
                    { value: 'dispatched', label: '已发货' },
                    { value: 'in_transit', label: '运输中' },
                    { value: 'delivered', label: '已完成' },
                    { value: 'cancelled', label: '已取消' }
                ];

                statusOptions.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.label;
                    opt.selected = order.status === option.value;
                    statusSelect.appendChild(opt);
                });
                statusCell.appendChild(statusSelect);

                const actionCell = row.insertCell(10);
                const updateBtn = document.createElement('button');
                updateBtn.textContent = '更新状态';
                updateBtn.className = 'update-status-btn';
                updateBtn.onclick = () => updateOrderStatus(order.id);
                actionCell.appendChild(updateBtn);
            });
        }

        async function updateOrderStatus(orderId) {
            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (!orderRow) {
                showMessage(`更新失败: 找不到订单 ${orderId} 的行`, true);
                return;
            }
            const selectElement = orderRow.querySelector('select.status-select');
            if (!selectElement) {
                showMessage(`更新失败: 找不到订单 ${orderId} 的状态选择框`, true);
                return;
            }
            const newStatus = selectElement.value;

            const updateBtn = orderRow.querySelector('.update-status-btn');
            if (updateBtn) {
                updateBtn.disabled = true;
                updateBtn.textContent = '更新中...';
            }

            try {
                await apiRequest(`/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: { status: newStatus }
                });
                showMessage(`订单 ${orderId} 状态已更新为: ${newStatus}`, false);
                await loadAllOrders(); // 刷新列表
            } catch (error) {
                console.error('更新订单状态失败:', error);
                showMessage(`更新订单状态失败: ${error.message}`, true);
            } finally {
                if (updateBtn) {
                    updateBtn.disabled = false;
                    updateBtn.textContent = '更新状态';
                }
            }
        }

        // --- 已批准租户逻辑 (新增) ---
        async function loadApprovedTenants() {
            try {
                const response = await apiRequest('/admin/tenants/approved'); // 假设后端有此 API
                const tenants = response.data; // 假设返回格式也是 { data: [...] }

                const tbody = document.getElementById('approved-tenants-body');
                tbody.innerHTML = ''; // 清空

                if (!Array.isArray(tenants) || tenants.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="6">暂无已激活租户</td></tr>';
                     return;
                }

                tenants.forEach(tenant => {
                    const row = document.createElement('tr');
                    const createdAt = new Date(tenant.created_at).toLocaleString();
                    // 状态可以根据后端定义调整，例如 'active'
                    const statusLabel = tenant.status === 'active' ? '已激活' : tenant.status;
                    row.innerHTML = `
                        <td>${tenant.id}</td>
                        <td>${tenant.name}</td>
                        <td>${tenant.contact_person}</td>
                        <td>${tenant.contact_phone}</td>
                        <td>${statusLabel}</td>
                        <td>${createdAt}</td>
                        <!-- <td>可能的操作按钮</td> -->
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('加载已激活租户失败:', error);
                showMessage(`加载已激活租户失败: ${error.message}`, true);
                document.getElementById('approved-tenants-body').innerHTML = `<tr><td colspan="6">加载失败，请刷新重试。</td></tr>`;
            }
        }


        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            checkStoredToken(); // 检查登录状态

            if (loginForm) {
                loginForm.addEventListener('submit', login);
            }

            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }

            // 初始加载数据（如果用户已登录）
            if (!loginSection.classList.contains('hidden')) {
                 // 用户未登录，不加载数据
            } else {
                 // 用户已登录，加载数据
                 // loadPendingTenants(); // 可以选择性加载
                 // loadAllOrders();      // 可以选择性加载
                 // loadApprovedTenants(); // 可以选择性加载
            }
        });

    </script>
</body>
</html>