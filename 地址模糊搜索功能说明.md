# 地址模糊搜索功能说明

## 功能概述

为停靠点管理页面添加了腾讯地图 API 地址模糊搜索功能，用户输入关键词即可搜索地址并自动填充经纬度。

## 涉及文件

| 文件路径 | 用途 | 用户群体 |
|---------|------|----------|
| `web/tenant-web/public/stop-points.html` | 承运商上传停靠点 | 承运商（物流公司） |
| `web/tenant-web/public/carrier-stop-points.html` | 承运商管理停靠点 | 承运商（物流公司） |
| `web/admin-web/public/stop-points.html` | 管理员管理停靠点 | 系统管理员 |

## 功能特性

### 1. 地址模糊搜索
- 用户输入关键词（如"朝阳大悦城"）
- 等待 300ms 后自动显示搜索结果下拉列表
- 点击任意结果，自动填充地址和坐标

### 2. 根据地址获取坐标
- 输入完整地址后点击"根据地址获取坐标"按钮
- 调用地理编码 API 获取精确坐标
- 自动填充经纬度（保留 3 位小数）

### 3. 测试 API Key
- 点击绿色"测试 API"按钮
- 快速验证 API Key 是否有效
- 显示返回结果数量

## API 配置

### 腾讯地图 API Key

当前使用的 API Key（示例）：
```
C66BZ-TKWWW-MWJR2-Y4BT5-5IQXJ-2EBBJ
```

### 如何获取 API Key

1. 访问 [腾讯地图开放平台](https://lbs.qq.com/)
2. 注册/登录账号
3. 进入"控制台" → "应用管理" → "我的应用"
4. 创建新应用，选择"Web 服务 API"
5. 设置 IP 白名单（开发环境可设为 `0.0.0.0/0`）
6. 创建后获得 API Key

### 配置位置

在三个文件中搜索 `C66BZ-TKWWW-MWJR2-Y4BT5-5IQXJ-2EBBJ`，替换为您自己的 API Key。

## API 说明

### 地理编码 API
- **用途**：根据地址获取经纬度
- **URL**：`https://apis.map.qq.com/ws/geocoder/v1/`
- **参数**：`address`（地址）、`key`（API Key）、`callback`（JSONP 回调）
- **示例**：
  ```
  https://apis.map.qq.com/ws/geocoder/v1/?address=朝阳大悦城&key=YOUR_KEY&callback=cb_123
  ```

### 地点建议 API
- **用途**：根据关键词搜索地点
- **URL**：`https://apis.map.qq.com/ws/place/v1/suggestion/`
- **参数**：`keyword`（关键词）、`key`（API Key）、`callback`（JSONP 回调）
- **示例**：
  ```
  https://apis.map.qq.com/ws/place/v1/suggestion/?keyword=北京&key=YOUR_KEY&callback=cb_123
  ```

## 调用方式

### JSONP 方式（避免 CORS 限制）

由于浏览器 CORS 限制，使用 JSONP 方式调用 API：

```javascript
function jsonpRequest(type, keyword, panel) {
  const KEY = 'YOUR_API_KEY';
  const callbackName = 'cb_' + Date.now();
  
  window[callbackName] = function(data) {
    // 处理返回数据
    delete window[callbackName];
    script.remove();
  };
  
  const script = document.createElement('script');
  script.src = `https://apis.map.qq.com/...?key=${KEY}&callback=${callbackName}`;
  document.body.appendChild(script);
}
```

## 调试日志

控制台输出以下日志帮助调试：

| 日志前缀 | 说明 |
|---------|------|
| `[INIT]` | 初始化日志 |
| `[INPUT]` | 用户输入日志 |
| `[SEARCH]` | 搜索日志 |
| `[JSONP]` | API 请求日志 |
| `[FILL]` | 填充日志 |
| `[TEST]` | 测试日志 |

## 使用方法

### 方式 1：模糊搜索（推荐）
1. 打开停靠点上传/管理页面
2. 点击"新增停靠点"或"上传停靠点"
3. 在地址输入框输入关键词（如"朝阳大悦城"）
4. 等待 300ms，自动显示搜索结果下拉列表
5. 点击任意结果，自动填充地址和坐标

### 方式 2：手动获取坐标
1. 在地址输入框输入完整地址
2. 点击"根据地址获取坐标"按钮
3. 坐标自动填充（保留 3 位小数）

### 方式 3：测试 API
1. 点击绿色"测试 API"按钮
2. 查看弹窗结果
3. 如果显示"API Key 有效"，说明配置正确

## 常见问题

### 1. 显示"API Key 无效"
- **原因**：API Key 未配置或已过期
- **解决**：登录腾讯地图开放平台创建新的 API Key

### 2. 显示"此 key 每日调用量已达到上限"
- **原因**：API Key 的每日配额已用完
- **解决**：
  - 等待第二天（UTC+8 0 点重置）
  - 创建新的 API Key
  - 升级 API Key 配额

### 3. 显示"来源 IP 未被授权"
- **原因**：IP 不在白名单内
- **解决**：在腾讯地图控制台配置 IP 白名单

### 4. 显示"网络请求失败"
- **原因**：网络不通或防火墙拦截
- **解决**：
  - 检查网络连接
  - 关闭防火墙或代理
  - 联系 IT 部门

## 代码结构

```
stop-points.html
├── HTML 部分
│   ├── 地址输入框（带 placeholder）
│   ├── 根据地址获取坐标按钮
│   ├── 测试 API 按钮（绿色）
│   └── searchResults 下拉列表容器
│
└── JavaScript 部分
    ├── initAddressSearch()      - 初始化地址搜索
    ├── getCoordsFromAddress()   - 根据地址获取坐标
    ├── searchPlaces()           - 模糊搜索地点
    ├── jsonpRequest()           - JSONP 请求通用函数
    ├── fillAddress()            - 填充地址和坐标
    └── testApiKey()             - 测试 API Key
```

## 注意事项

1. **API Key 安全**：不要将 API Key 提交到公开代码仓库
2. **配额管理**：监控 API 调用量，避免超出配额
3. **IP 白名单**：生产环境建议配置 IP 白名单
4. **经纬度精度**：保留 3 位小数（约 100 米精度），满足物流需求
5. **错误处理**：所有 API 调用都有错误处理和用户提示

## 更新日志

- **2026-02-20**：初始版本，使用 fetch 调用（有 CORS 问题）
- **2026-02-20**：改为 JSONP 方式调用，解决 CORS 问题
- **2026-02-20**：添加详细调试日志
- **2026-02-20**：添加测试 API 按钮
- **2026-02-20**：添加详细使用注释
- **2026-02-20**：统一三个文件的实现
