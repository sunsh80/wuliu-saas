---
# API端点生成模板

## 目的
此模板用于生成符合项目规范的API端点代码。

## 模板结构

### 1. 文件头
```javascript
/**
 * <%= endpointDescription %>
 * 
 * API规范: <%= apiSpecPath %>
 * 验证规则: <%= validationRules %>
 * 
 * @param {Object} c - OpenAPI上下文对象
 * @returns {Object} - API响应对象
 */
// AI-META: TYPE api_handler
// AI-META: ENDPOINT <%= httpMethod %> <%= endpointPath %>
// AI-META: VALIDATES <%= validatedFields %>
// AI-META: USES <%= usedSchemas %> schema
```

### 2. 主函数结构
```javascript
module.exports = async (c) => {
  // 1. 解构请求参数
  const { <%= requestParams %> } = c.request.body;
  
  // 2. 验证输入数据
  // 使用共享验证库进行验证
  const { <%= validationFunctions %> } = require('<%= validationLibraryPath %>');
  
  <% if (hasPhoneValidation) { %>
  if (!validatePhone(<%= phoneParam %>)) {
    return {
      statusCode: 400,
      body: {
        success: false,
        error: 'INVALID_PHONE_FORMAT',
        message: 'Phone number format is invalid'
      }
    };
  }
  <% } %>
  
  // 3. 业务逻辑处理
  try {
    // 数据库操作
    const db = require('<%= dbPath %>').getDb();
    
    // 业务处理逻辑
    <%= businessLogic %>
    
    // 4. 返回成功响应
    return {
      statusCode: 200,
      body: {
        success: true,
        message: '<%= successMessage %>',
        data: result
      }
    };
  } catch (error) {
    // 5. 错误处理
    console.error('<%= endpointName %> error:', error);
    return {
      statusCode: 500,
      body: {
        success: false,
        error: 'INTERNAL_SERVER_ERROR',
        message: 'Internal server error occurred'
      }
    };
  }
};
```

### 3. 验证中间件模板
```javascript
/**
 * <%= endpointName %> 验证中间件
 * 使用API验证器验证请求数据
 */
const { createFieldValidator } = require('<%= apiValidatorPath %>');

// 验证特定字段
const validate<%= endpointName %>Fields = createFieldValidator([
  <%= validatedFieldsList %>
]);

module.exports = validate<%= endpointName %>Fields;
```

### 4. 数据库模型模板
```javascript
/**
 * <%= modelName %> 模型
 * 与 <%= tableName %> 表交互
 * 
 * DB-FIELD: <%= tableFields %>
 * VALIDATION: <%= validationRules %>
 */
class <%= modelName %> {
  /**
   * 创建新记录
   * @param {Object} data - <%= modelName %> 数据
   * @returns {Promise<Object>} - 创建的记录
   */
  static async create(data) {
    // 验证输入数据
    const validationResult = validateObject(data);
    if (!validationResult.isValid) {
      throw new Error(`Validation failed: ${validationResult.errors}`);
    }
    
    const db = require('<%= dbPath %>').getDb();
    
    // 执行数据库操作
    const result = await db.run(
      `INSERT INTO <%= tableName %> (<%= fieldList %>) VALUES (<%= placeholderList %>)`,
      [<%= valueList %>]
    );
    
    return { id: result.lastID, ...data };
  }
  
  /**
   * 根据ID查找记录
   * @param {number} id - 记录ID
   * @returns {Promise<Object|null>} - 查找到的记录或null
   */
  static async findById(id) {
    const db = require('<%= dbPath %>').getDb();
    return await db.get(`SELECT * FROM <%= tableName %> WHERE id = ?`, [id]);
  }
  
  // 其他CRUD操作...
}

module.exports = <%= modelName %>;
```

## 使用说明

1. 将模板变量替换为实际值
2. 确保验证规则与validation-metadata.json一致
3. 遌意错误处理和日志记录
4. 遌保代码符合项目的架构模式

## AI指令
// AI-INSTRUCTION:
// When generating code using this template:
// 1. Replace all template variables with appropriate values
// 2. Ensure validation rules match those in validation-metadata.json
// 3. Follow the project's error handling patterns
// 4. Maintain consistency with existing code style
// 5. Add appropriate JSDoc comments
// 6. Include AI-META comments for better understanding